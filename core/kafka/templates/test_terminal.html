{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}
{% load common_tags %}

{% block page_title %}Test terminal page{% endblock %}
{% block title %}PanDA monitor{% endblock %}
{% block subtitle %} {{ viewParams.selection|safe }} {% endblock %}
{% block css_page_library %}
  <link rel="stylesheet" href="{% static 'js/jquery-ui/jquery-ui.css' %}">
  <link rel="stylesheet" href="{% static 'css/jquery.terminal.min.css' %}"/>
{% endblock %}

{% block css_page %}
{% endblock %}

{% block js_head_page_library %}
    <script src="{% static 'js/jquery.terminal.min.js' %}"></script>
{% endblock %}

{% block body %}
    <div id="web-terminal"></div>
{#        <div class="container">#}
{#            <div class="row">#}
{#                <div class="col-6 mx-auto mt-5">#}
{#                    <h1 id="app">{{text}}</h1>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{% endblock %}

{% block js_body_page %}
       <script>
            var socket = new WebSocket('ws://aipanda163.cern.ch:8002/ws/kafka_messages/');
            var terminal = $('#web-terminal').terminal(
                    function(command, term) {
                        if (command == 'help') {
                            term.echo('Help command');
                        }
                        if (command == 'start') {
                            {#term.pause();#}

                            {#$.post('{% url 'getpayloadlog' %}', {#}
                            {#    pandaid:{{pandaid|safe}},#}
                            {#    start:0,#}
                            {#    length: 50,#}
                            {#    draw: 1,#}
                            {#    sort: 'asc',#}
                            {#    search: ''})#}
                            {#    .then(function(response) {#}
                            {#        term.echo(response).resume();#}
                            {#    });#}
                        }
                    },
                    {
                        greetings: 'Wellcome to BigPanDA Web Terminal. Created using jQuery terminal v2.52.2',
                        name: 'RealTimeLogs',
                        height: 600,
                        prompt: '> ',
                        onInit: function(term) {
                            term.pause();
                            {#term.echo('The last 50 messages from payload log')#}
                        socket.onmessage = function(event) {
                            var data = JSON.parse(event.data);
                            console.log(data);
                            term.echo(data.message)
                        }
                        },
                        keypress: function(e, term) {
                            if (e.which == 100 && e.ctrlKey) {
                                stop = true;
                                term.resume();
                                return false;
                            }
                        }
                    });
        </script>
{% endblock %}