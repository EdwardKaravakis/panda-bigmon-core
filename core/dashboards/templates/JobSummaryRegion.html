{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}

{% block page_title %} {{ viewParams.MON_VO }} PanDA jobs{% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block subtitle %}PanDA {{view}} {{ requestParams.mode }} dashboard{% endblock %}

{% block time_window %}
    Modification time window: <span class="time-window-range">{{ request.session.timerange.0 }}</span>
    - <span class="time-window-range">{{ request.session.timerange.1 }}</span> UTC
{% endblock %}

{% block css_page_library %}
  <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
  <link rel="stylesheet" href="{% static "js/datatables/Buttons-1.2.4/css/buttons.foundation.min.css" %}">
{% endblock %}
{% block js_head_page_library %}
  <script src="{% static 'js/humanize.min.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/buttons.foundation.min.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/buttons.colVis.min.js' %}"></script>
  <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
{% endblock %}


{% block body %}

<div class="callout primary" data-closable>
  <h5><b>This is a new dashboard page!</b></h5>
  <p>The old one is still available, via the links:
    <a class="blacklink" href="{% url 'dashboard' %}?version=old"><b>all</b></a>,
    <a class="blacklink" href="{% url 'dashProduction' %}?version=old"><b>production</b></a>,
    <a class="blacklink" href="{% url 'dashAnalysis' %}?version=old"><b>analysis</b></a>. But it will be decommissioned soon.
  </p>
  <p>This page summarizes recent job status for regions and queues. The time limit is not applied for jobs in active states.</p>
  <p>Use <b>drop-down select menus</b> on top of the page to select particular queue type and status, job type and resource type.
    Use <b>Split by check boxes</b> to separate the region/site statistics by job and/or resource type.
      I.e. if you check the <b>split by job type</b> checkbox, you will get up to 2 rows in tables for each Region/PQ showing number of production and analysis jobs separately.
      If you check the <b>split by resource type</b> checkbox, you will get up to 4 rows in tables for each Region/PQ showing number of jobs using SCORE, MCORE, SCORE_HIMEM and MCORE_HIMEM resources separately.
      If you check both checkboxes, you will get up to 8 rows for each Region/PQ showing split statistics of jobs.
    Click on <b>Update</b> button to apply selection.</p>
  <p><b>By default the view is minimized</b>, i.e. some short transient states and Harvester workers summary numbers are hidden.
    Press <b>Show details</b> buttons to see all the states of jobs and workers.</p>
  <p>Click the job counts to go to job listings. Click on workers counts to go to harvester workers listings.
    Use the <b>Search</b> text input on the top of second table to find a PQ by name.</p>
  <p>Click on PQ name to go to a BigPanDA site info page. Next to a PQ name there are 3 links:
    <img src="{% static '/images/grafana.png' %}" width=14 height=14 border=0> goes to Jobs accounting for a PQ at MONIT Grafana;
    <img src="{% static '/images/grafana-black.png' %}" width=14 height=14 border=0> - Jobs monitoring for a PQ at MONIT Grafana (Eric's monitoring);
    <img src="{% static '/images/kibana-logo.png' %}" width=14 height=14 border=0> - recent brokerage actions related to a PQ at Kibana.
  </p>
  <p>Click on a PQ status to go to blacklisting history at CRIC UI.</p>
  <p><b>N running workers</b> column has the next color coding scheme:
    <span class="alert"><b>dark red</b></span> if N running workers > N running jobs for more than 20%,
    <span class="warning"><b>orange</b></span> if N running workers > N running jobs for more than 10% and less than 20%.</p>
  <p>If you want too see more rows in tables by default, add <b>&display_limit=N</b> to URL where N is desired number.
     You can change the default last 12 hours time range by clicking a blue "Change" button in the top sub-bar. </p>
  <p>If you notice any issue or if you have an advise how to improve the page, please let us know
    <a class="blacklink" href="mailto:atlas-adc-pandamon-support@cern.ch"><b>atlas-adc-pandamon-support@cern.ch</b></a> !</p>
  <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
    <span aria-hidden="true">&times;</span>
  </button>
</div>

{% if viewParams.selection %}
  {{ viewParams.selection|safe }}
{% endif %}

<div data-ng-app="jobSummaryRegion">
<div data-ng-controller="JobSummaryRegionController" id="div-jobSummaryRegion">
<form novalidate class="simple-form">
<div class="row form-container">
<div class="medium-1 column">
    <label>Region:
    <select id="region__select" ng-model="dash.selection.region" ng-options="qt.name as qt.name for qt in dash.availableOptions.region">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Site:
    <select id="region__select" ng-model="dash.selection.site" ng-options="qt.name as qt.name for qt in dash.availableOptions.site | filter:{region:dash.selection.region}">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Queue type:
    <select id="queuetype__select" ng-model="dash.selection.queuetype" ng-options="qt.name as qt.name for qt in dash.availableOptions.queuetype">
    </select>
    </label>
</div>
<div class="medium-1 column">
    <label>Queue status:
    <select id="queuestatus__select" ng-model="dash.selection.queuestatus" ng-options="qs.name as qs.name for qs in dash.availableOptions.queuestatus">
    </select>
    </label>
</div>
<div class="medium-1 column">
    <label>Job type:
    <select id="jobtype__select"
            ng-model="dash.selection.jobtype"
            ng-options="jt.name as jt.name for jt in dash.availableOptions.jobtype"
            ng-change="change(dash.selection)">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Resource type:
    <select id="resourcetype__select"
            ng-model="dash.selection.resourcetype"
            ng-options="rt.name as rt.name for rt in dash.availableOptions.resourcetype"
            ng-change="change(dash.selection)">
    </select>
    </label>
</div>
<fieldset class="medium-2 column">
    <legend>Split by:</legend>
    <ul class="no-bullet">
      <li class="list-item"><input id="jobtype" type="checkbox" ng-model="dash.selection.splitby.jobtype"><label for="jobtype">job type</label>
      </li>
      <li class="list-item"><input id="resourcetype" type="checkbox" ng-model="dash.selection.splitby.resourcetype"><label for="resourcetype">resource type</label>
      </li>
    </ul>
</fieldset>
<div class="medium-1 column">
    <a class="button primary" ng-click="update(dash.selection)">Update</a>
</div>
</div>
</form>
</div>
</div>

<div class="card bp-container-simple secondary" id="container_rs" style="display: none; font-size: 0.875rem">
<div class="card-divider"><p>Region summary:</p></div>
<div class="card-section">
<table id='regionsummary' class="data-table nowrap hover">
  <thead>
  <tr>
      <th class="text">Region</th>
      <th class="text">Job type</th>
      <th class="text">Resource type</th>
      <th class="num">N submitted workers</th>
      <th class="num">N running workers</th>
      <th class="num">N running slots</th>
      <th class="num">N jobs total</th>
      <th class="num">% failure</th>
      {% for js in jobstates %}
          <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
      {% endfor %}
  </tr>
  </thead>
  <tbody>
  </tbody>
  <tfoot>
  <tr>
      <th class="text">Region</th>
      <th class="text">Job type</th>
      <th class="text">Resource type</th>
      <th class="num">N submitted workers</th>
      <th class="num">N running workers</th>
      <th class="num">N running slots</th>
      <th class="num">N jobs total</th>
      <th class="num">% failure</th>
      {% for js in jobstates %}
          <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
      {% endfor %}
  </tr>
  </tfoot>
</table>
</div>
</div>

<div class="card bp-container-simple secondary" id="container_qs" style="display: none; font-size: 0.875rem">
<div class="card-divider"><p>Queue summary:</p></div>
<div class="card-section">
<table id='queuesummary' class="data-table nowrap hover">
  <thead>
  <tr>
    <th class="text icons3">Queue name</th>
    <th class="text">Queue type</th>
    <th class="text">Region</th>
    <th class="text">Status</th>
    <th class="text">Job type</th>
    <th class="text">Resource type</th>
    <th class="num">N submitted workers</th>
    <th class="num">N running workers</th>
    <th class="num">N running slots</th>
    <th class="num">N jobs total</th>
    <th class="num">% failure</th>
    {% for js in jobstates %}
        <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
    {% endfor %}
  </tr>
  </thead>
  <tbody>
  </tbody>
  <tfoot>
  <tr>
    <th class="text icons3">Queue name</th>
    <th class="text">Queue type</th>
    <th class="text">Region</th>
    <th class="text">Status</th>
    <th class="text">Job type</th>
    <th class="text">Resource type</th>
    <th class="num">N submitted workers</th>
    <th class="num">N running workers</th>
    <th class="num">N running slots</th>
    <th class="num">N jobs total</th>
    <th class="num">% failure</th>
    {% for js in jobstates %}
        <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
    {% endfor %}
  </tr>
  </tfoot>
</table>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>

var select_params = {{ selectParams | safe }};
var request_params = {{ requestParams | safe }};
var err_threshold = 15;

app.controller('JobSummaryRegionController', ['$scope', function($scope) {
    $scope.dash = {
        selection: {
            region: 'all',
            site: 'all',
            queuetype: 'all',
            queuestatus: 'all',
            jobtype: 'all',
            resourcetype: 'all',
            splitby: {
                jobtype: false,
                resourcetype: false,
            },
        }
    };

    $scope.dash.availableOptions = {
        region: [{name:'all', value:'', query: ''},],
        site: [{name:'all', value:'', region:'all', query:'' },],
        queuetype: [{name:'all', value:'', query: ''},],
        queuestatus: [{name:'all', value:'', query: ''},],
        jobtype: [
          {name:'all', value:'', query: ''},
          {name:'analy', value:'analy', query: 'jobtype=analy&'},
          {name:'prod', value:'prod', query: 'jobtype=prod&'},
        ],
        resourcetype: [
          {name:'all', value:'', query: ''},
          {name:'SCORE', value:'SCORE', query: 'resourcetype=SCORE&'},
          {name:'SCORE_HIMEM', value:'SCORE_HIMEM', query: 'resourcetype=SCORE_HIMEM&'},
          {name:'MCORE', value:'MCORE', query: 'resourcetype=MCORE&'},
          {name:'MCORE_HIMEM', value:'MCORE_HIMEM', query: 'resourcetype=MCORE_HIMEM&'}
        ],
    };
    select_params.region.forEach(function (param) {
     $scope.dash.availableOptions.region.push({name:param, value:param, query:'region' + param + '&'});
     $scope.dash.availableOptions.site.push({name:'all', value:'', region:param, query:'' });
    });

    select_params.site.forEach(function (param) {
     $scope.dash.availableOptions.site.push({name:param.site, value:param.site, region:param.region + '_all', query:'site' + param + '&' });
    });

    select_params.queuetype.forEach(function (param) {
     $scope.dash.availableOptions.queuetype.push({name:param, value:param, query:'queuetype' + param + '&'});
    });

    select_params.queuestatus.forEach(function (param) {
     $scope.dash.availableOptions.queuestatus.push({name:param, value:param, query:'queuestatus' + param + '&'});
    });

    Object.keys($scope.dash.availableOptions).forEach(function (key) {
        if (key in request_params && typeof request_params[key] === 'string') {$scope.dash.selection[key] = request_params[key]}
    });
    if ('hours' in request_params) {$scope.dash.selection.hours = parseInt(request_params.hours)}
    if ('splitby' in request_params) {
        if (request_params.splitby.indexOf('jobtype') !== -1) {
            $scope.dash.selection.splitby.jobtype = true
        }
        if (request_params.splitby.indexOf('resourcetype') !== -1) {
            $scope.dash.selection.splitby.resourcetype = true
        }
    }

    $scope.update = function(selection) {
        var query = '{% url 'dashRegion' %}?';
        if ('date_from' in request_params && 'date_to' in request_params) {
          query += 'date_from=' + request_params.date_from + '&';
          query += 'date_to=' + request_params.date_to  + '&';
        }
        Object.keys(selection).forEach(function (key) {
            if (key === 'splitby') {
                let subquery = 'splitby=';
                Object.keys(selection.splitby).forEach(function (sbkey) {
                    if (selection.splitby[sbkey] === true) {subquery += sbkey + ','}
                });
                if (subquery.length > 10) {
                    subquery = subquery.substring(0, subquery.length - 1);
                    query += subquery + '&';
                }
            }
            else {
                if (selection[key] !== 'all') {
                    query += key + '=' + selection[key].toString() + '&'
                }
            }
        });
        query = query.substring(0, query.length - 1);
        window.location = query;
    };

    $scope.change = function (selection) {
        (selection.jobtype.length > 0) ? $scope.dash.selection.splitby.jobtype = true : $scope.dash.selection.splitby.jobtype = false;
        (selection.resourcetype.length > 0) ? $scope.dash.selection.splitby.resourcetype = true : $scope.dash.selection.splitby.resourcetype = false;
    }
}]);

$(document).ready(function () {
    var regionsummary = {{ regions|safe }};
    var regionsTable = buildRegionSummary(regionsummary, 'regionsummary');
    $('#container_rs').css( 'display', 'block' );
    regionsTable.columns.adjust().draw();
    var queuesummary = {{ queues|safe }};
    var queuesTable = buildQueueSummary(queuesummary, 'queuesummary');
    $('#container_qs').css( 'display', 'block' );
    queuesTable.columns.adjust().draw();
});

function buildRegionSummary(data, divid) {
    var regionsTable = $('#' + divid).DataTable({
        "iDisplayLength": -1,
        "lengthChange": false,
        "paging": false,
        "bFilter": false, // remove search box
        "aaSorting": [[0,'asc']],
        "scrollX": true,
        "autoWidth": true,
        "data": data,
        "buttons": [
          {
            extend: 'colvisGroup',
            text: 'Minimize view',
            hide: [ 3,4,5,8,9,10,12,14,15,17,22,23 ],
          },
          {
            extend: 'colvisGroup',
            text: 'Show details',
            show: ':hidden',
          }
        ],
        "aoColumns": [
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}region=' + row[0] + '">'+row[0]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}jobtype=' + row[1] + '">'+row[1]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}resourcetype=' + row[2] + '">'+row[2]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '">'+row[6]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "alert num",
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.0 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.0 }}' + '">'+row[8]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.1 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.1 }}' + '">'+row[9]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.2 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.2 }}' + '">'+row[10]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.3 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.3 }}' + '">'+row[11]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.4 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.4 }}' + '">'+row[12]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.5 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.5 }}' + '">'+row[13]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.6 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.6 }}' + '">'+row[14]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.7 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.7 }}' + '">'+row[15]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.8 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.8 }}' + '">'+row[16]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.9 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.9 }}' + '">'+row[17]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.10 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.10 }}' + '">'+row[18]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.11 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.11 }}' + '">'+row[19]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.12 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.12 }}' + '">'+row[20]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.13 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.13 }}' + '">'+row[21]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.14 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.14 }}' + '">'+row[22]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.15 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.15 }}' + '">'+row[23]+'</a>';
                return url_link
            }
          },
        ],
        "createdRow": function (row, data, index) {
          if (data[7] > err_threshold) {
            $('td', row).eq(7).addClass('bold');
          }
        },
    });
    regionsTable.columns( [3,4,5,8,9,10,12,14,15,17,22,23] ).visible( false );
    regionsTable.buttons().container()
        .appendTo( '#regionsummary_wrapper .small-6.columns:eq(0)' );
    return regionsTable
}

function buildQueueSummary(data, divid) {
  let lengthMenu = [[10, 20, 50, 100, -1], [10, 20, 50, 100, "All"]];
  let iDisplayLength = 20;
  if ('display_limit' in request_params) {
    lengthMenu = [[10, request_params.display_limit, -1], [10, request_params.display_limit, "All"]]
    iDisplayLength = request_params.display_limit;
  }
  var queuesTable = $('#' + divid).DataTable({
    "iDisplayLength": iDisplayLength,
    "lengthMenu": lengthMenu,
    "paging": true,
    "aaSorting": [[0,'asc']],
    "scrollX": true,
    "autoWidth": true,
    "data": data,
    "buttons": [
      {
        extend: 'colvisGroup',
        text: 'Minimize view',
        hide: [ 6,7,8,11,12,13,15,17,18,20,25,26 ]
      },
      {
        extend: 'colvisGroup',
        text: 'Show details',
        show: ':hidden'
      }
    ],
    "columns": [
      {
        sDefaultContent: "---",
        className: "text icons3",
        "render": function(data, type, row, meta) {
            let link = '<a href = "{% url 'siteInfo' %}' + row[0] + '/">'+row[0]+'</a>';
            link += ' <a target="_blank" href="https://monit-grafana.cern.ch/d/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite=' + row[0] + '&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1"><div class="tooltip-right"><img src="/static/images/grafana.png" width=14 height=14 border=0><span container="body" class="tooltip-text">Jobs accounting (MONIT Grafana)</span></div></a>\n';
            link += ' <a onclick=\'PopUpGrafana("' + row[0] + '", "' + row[4] +  '", "' + row[5] +  '", "jmonit")\'><div class="tooltip-right"><img src="/static/images/grafana-black.png" width=14 height=14 border=0><span class="tooltip-text">Jobs monitoring (rendered Grafana plot)</span></div></a>\n';
            link += ' <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana#/dashboard/f3042400-aa4d-11ea-88a6-cd72c8759873?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:\'Job%20brokerage\',filters:!(),fullScreenMode:!f,options:(darkTheme:!f,useMargins:!f),panels:!((gridData:(h:2,i:\'4\',w:3,x:0,y:0),id:e9b265f0-6627-11e7-9c82-4bf763932475,panelIndex:\'4\',type:visualization,version:\'6.2.4\'),(gridData:(h:8,i:\'5\',w:12,x:0,y:18),id:c3a4f160-50aa-11e9-a744-833d910adbcf,panelIndex:\'5\',type:visualization,version:\'6.2.4\'),(gridData:(h:6,i:\'6\',w:3,x:0,y:5),id:\'991ce6b0-aa5d-11ea-88a6-cd72c8759873\',panelIndex:\'6\',type:visualization,version:\'6.2.4\'),(gridData:(h:11,i:\'7\',w:9,x:3,y:0),id:\'5c7b65a0-aa5e-11ea-88a6-cd72c8759873\',panelIndex:\'7\',type:visualization,version:\'6.2.4\'),(gridData:(h:7,i:\'8\',w:12,x:0,y:11),id:b7c043e0-aa5e-11ea-88a6-cd72c8759873,panelIndex:\'8\',type:search,version:\'6.2.4\'),(gridData:(h:3,i:\'9\',w:3,x:0,y:2),id:\'6c76ff00-aa68-11ea-88a6-cd72c8759873\',panelIndex:\'9\',type:visualization,version:\'6.2.4\')),query:(language:lucene,query:\'site.keyword:%20%2F' + row[0] + '%5C%2F.*%2F%20OR%20site.keyword:%20%22' + row[0] + '%22\'),timeRestore:!t,title:jedilogs_jobbrokerage,viewMode:view)"><div class="tooltip-right"><img src="/static/images/kibana-logo.png" width=14 height=14 border=0><span class="tooltip-text">Brokerage actions (Kibana)</span></div></a>\n';
            link += ' <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana#/dashboard/a312a030-8b0e-11e8-a7e3-ffbb2f24f6b4?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:\'\',filters:!((\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'09f5a610-6810-11e9-a744-833d910adbcf\',key:computingsite.keyword,negate:!f,params:(query:' + row[0] + ',type:phrase),type:phrase,value:' + row[0] + '),query:(match:(computingsite.keyword:(query:' + row[0] + ',type:phrase))))))" ><div class="tooltip-right"><img src="/static/images/kibana-logo-black.png" width=14 height=14 border=0><span container="body" class="tooltip-text">Harvester particular computingsite dashboard (Kibana)</span> </div></a>';
            return link
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}region=' + row[2] + '">'+row[2]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
        render: function(data, type, row, meta) {
            return '<a href="https://atlas-cric.cern.ch/atlas/pandaqueuestatushistory/list/?pandaqueue=' + row[0] + '" target="_blank"><div class="tooltip-right"><span class="' + row[3] + '">' + row[3] + '</span><span class="tooltip-text">Blacklisting history (CRIC)</span></div></a>'
        }

      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}jobtype=' + row[4] + '">'+row[4]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}resourcetype=' + row[5] + '">'+row[5]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: function(data, type, row, meta) {
            return '<a href = "{% url 'harvesters' %}?hours=100&status=submitted&computingsite=' + row[0] + '">' + row[6] + '</a>';
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: function(data, type, row, meta) {
          let cellstr = '<a target="_blank" class="';
          let diffpct = 0;
          (row[19] !== 0) ? diffpct = (row[7] - row[19])*100./row[19] : diffpct = 0;
          if (diffpct > 20) {cellstr += 'alert';}
          else if (diffpct > 10) {cellstr += 'warning';}
          cellstr += '" href = "{% url 'harvesters' %}?hours=100&status=running&computingsite=' + row[0] + '">' + row[7] + '</a>';
          return cellstr
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: $.fn.dataTable.render.number( ',', '.'),
      },
      {
        sDefaultContent: "---",
        className: "num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '">'+row[9]+'</a>';
            return url_link
        }
      },
      {
        sDefaultContent: "---",
        className: "alert num",
      },
      {
        sDefaultContent: "---",
        className: "{{ jobstates.0 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.0 }}' + '">'+row[11]+'</a>';
            return url_link
        }
      },
      {
        sDefaultContent: "---",
        className: "{{ jobstates.1 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.1 }}' + '">'+row[12]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.2 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.2 }}' + '">'+row[13]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.3 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.3 }}' + '">'+row[14]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.4 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.4 }}' + '">'+row[15]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.5 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.5 }}' + '">'+row[16]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.6 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.6 }}' + '">'+row[17]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.7 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.7 }}' + '">'+row[18]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.8 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.8 }}' + '">'+row[19]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.9 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.9 }}' + '">'+row[20]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.10 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.10 }}' + '">'+row[21]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.11 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.11 }}' + '">'+row[22]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.12 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.12 }}' + '">'+row[23]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.13 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.13 }}' + '">'+row[24]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.14 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.14 }}' + '">'+row[25]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.15 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.15 }}' + '">'+row[26]+'</a>';
            return url_link
        }
      },
    ],
    "createdRow": function (row, data, index) {
      if (data[10] > err_threshold) {
        $('td', row).eq(10).addClass('bold');
      }
    },
  });
  queuesTable.columns( [ 6,7,8,11,12,13,15,17,18,20,25,26 ] ).visible( false );
  queuesTable.buttons().container()
    .appendTo( '#queuesummary_wrapper .small-6.columns:eq(0)' );
  return queuesTable
}

var newWinGrafana;
function PopUpGrafana(site, prod_source = 'All', res_cap = 'All', montype = 'jaccounting') {
  let title = 'PQ: ' + site + ', job type: ' + prod_source + ', resource type: '+ res_cap;
  switch (prod_source) {
    case 'all':
      prod_source = 'All';
      break;
    case 'analy':
      prod_source = 'user';
      break;
    case 'prod':
      prod_source = 'managed';
      break;
    default:
      prod_source = 'All'
  }
  if (res_cap === 'all') { res_cap = 'All'; }
  let tmstp = new Date();
  let strFeatures="toolbar=no,titlebar=no,status=no,menubar=no,location=no,scrollbars=no,resizable=no,height=600,width=1000";
  if (!newWinGrafana || newWinGrafana.closed) {
      newWinGrafana = window.open('', title + ', built at' + tmstp, strFeatures);
      if (!newWinGrafana.opener) {newWinGrafana.opener = window; }
  if (montype === 'jaccounting') {
      newWinGrafana.document.write('<img src="{% url 'grafana' %}?url=https://monit-grafana.cern.ch/render/d-solo/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite='+site+'&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1&panelId=138&width=1000&height=500&tz=Europe%2FBerlin" id="show_image"><p>');
  }
  else {
      newWinGrafana.document.write("<html><head>");
      newWinGrafana.document.write("<meta http-equiv='Content-Type' content='text/html; charset=windows-1251'>");
      newWinGrafana.document.write("<title>"+ title +"</title></head>");
      newWinGrafana.document.write("<body>");
      newWinGrafana.document.write('<img alt="Loading image..." id="show_image" src="{% url 'grafana' %}?url=https://monit-grafana.cern.ch/render/d-solo/VbKvjL2Zk/jobs-monitoring?orgId=17&from=now-24h/h&to=now&var-retention=10m&var-cloud=All&var-tier=All&var-federation=All&var-nucleus=All&var-site=All&var-queue=' + site + '&var-queue_state=All&var-prod_source=' + prod_source + '&var-resource=' + res_cap + '&var-resource_type=All&var-type=All&var-states=All&var-pilot_manager=All&var-pilot_version=All&var-harvester=All&var-workflow=All&var-frontier=All&var-fts_server=All&var-container_type=All&var-pledge=All&panelId=8&width=1400&height=1400&tz=Europe%2FZurich&timeout=3600&timestamp=' + tmstp.toISOString() + '" id="show_image" style="width:900px;height:600px;"><p>');
      newWinGrafana.document.write('<a target="_blank" href="https://monit-grafana.cern.ch/d/VbKvjL2Zk/jobs-monitoring?orgId=17&from=now-24h%2Fh&to=now&var-retention=10m&var-cloud=All&var-tier=All&var-federation=All&var-nucleus=All&var-site=All&var-queue='+ site +'&var-queue_state=All&var-prod_source=' + prod_source + '&var-resource=' + res_cap + '&var-resource_type=All&var-type=All&var-states=All&var-pilot_manager=All&var-pilot_version=All&var-harvester=All&var-workflow=All&var-frontier=All&var-fts_server=All&var-container_type=All&var-pledge=All">Jobs monitoring dashboard</a>');
      newWinGrafana.document.write('<p><input type="button" onclick=reloadImage("show_image"); value="Reload">');
      newWinGrafana.document.write('<input type=button value="Close" onclick="window.close();return false;">');
      newWinGrafana.document.write('</body>');

      var script_ri_el = newWinGrafana.document.createElement("script");
      var script_ri = newWinGrafana.document.createTextNode("function reloadImage(id) { let base_src = document.getElementById(id).src; document.getElementById(id).src = ''; let tmstp = new Date(); document.getElementById(id).src = base_src + '&timestamp=' + tmstp.toISOString(); }");
      script_ri_el.appendChild(script_ri);
      newWinGrafana.document.head.appendChild(script_ri_el);
  }
  newWinGrafana.document.close();
  } else {
      if (window.focus) {newWinGrafana.focus()}
  }
}
</script>
{% endblock %}

{% block help %}
{% include 'dashboardRegionViewHelp.html' with show='all' %}
{% endblock %}






