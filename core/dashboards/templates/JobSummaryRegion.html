{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}

{% block page_title %} {{ viewParams.MON_VO }} PanDA jobs{% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block subtitle %}PanDA {{view}} {{ requestParams.mode }} dashboard{% endblock %}

{% block time_window %}
    Modification time window: <span class="time-window-range">{{ timerange.0 }}</span>
    - <span class="time-window-range">{{ timerange.1 }}</span> UTC
{% endblock %}

{% block css_page_library %}
  <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
  <link rel="stylesheet" href="{% static "js/datatables/Buttons-1.2.4/css/buttons.foundation.min.css" %}">
{% endblock %}
{% block js_head_page_library %}
  <script src="{% static 'js/humanize.min.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/buttons.foundation.min.js' %}"></script>
  <script src="{% static 'js/datatables/Buttons-1.2.4/js/buttons.colVis.min.js' %}"></script>
  <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
{% endblock %}


{% block body %}

<div class="callout primary" data-closable>
  <h5><b>This is a new dashboard page!</b></h5>
  <p>This page summarizes recent job status for regions and queues. The time limit is not applied for jobs in active states.</p>
  <p>Use <b>drop-down select menus</b> on top of the page to select particular queue type and status, job type and resource type.
    Use <b>Split by check boxes</b> to separate the region/site statistics by job and/or resource type.
    Click on <b>Update</b> button to apply selection.</p>
  <p><b>By default the view is minimized</b>, i.e. some short transient states and Harvester workers summary numbers are hidden.
    Press <b>Show details</b> buttons to see all the states of jobs and workers.</p>
  <p>Click the job counts to go to job listings. Click on workers counts to go to harvester workers listings.
    Use the <b>Search</b> text input on the top of second table to find a PQ by name.</p>
  <p><b>N running workers</b> column has the next color coding scheme:
    <span class="alert"><b>dark red</b></span> if N running workers > N running jobs for more than 20%,
    <span class="warning"><b>orange</b></span> if N running workers > N running jobs for more than 10% and less than 20%.</p>
  <p>If you notice any issue or if you have an advise how to improve the page, please let us know
    <a class="blacklink" href="mailto:atlas-adc-pandamon-support@cern.ch"><b>atlas-adc-pandamon-support@cern.ch</b></a> !</p>
  <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
    <span aria-hidden="true">&times;</span>
  </button>
</div>

{% if viewParams.selection %}
  {{ viewParams.selection|safe }}
{% endif %}

<div data-ng-app="jobSummaryRegion">
<div data-ng-controller="JobSummaryRegionController">
<form novalidate class="simple-form">
<div class="row form-container">
<div class="medium-1 column">
    <label>Region:
    <select id="region__select" ng-model="dash.selection.region" ng-options="qt.value as qt.name for qt in dash.availableOptions.region">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Queue type:
    <select id="queuetype__select" ng-model="dash.selection.queuetype" ng-options="qt.value as qt.name for qt in dash.availableOptions.queuetype">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Queue status:
    <select id="queuestatus__select" ng-model="dash.selection.queuestatus" ng-options="qs.value as qs.name for qs in dash.availableOptions.queuestatus">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Job type:
    <select id="jobtype__select"
            ng-model="dash.selection.jobtype"
            ng-options="jt.value as jt.name for jt in dash.availableOptions.jobtype"
            ng-change="change(dash.selection)">
    </select>
    </label>
</div>
<div class="medium-2 column">
    <label>Resource type:
    <select id="resourcetype__select"
            ng-model="dash.selection.resourcetype"
            ng-options="rt.value as rt.name for rt in dash.availableOptions.resourcetype"
            ng-change="change(dash.selection)">
    </select>
    </label>
</div>
<fieldset class="medium-2 column">
    <legend>Split by:</legend>
    <ul class="no-bullet">
      <li class="list-item"><input id="jobtype" type="checkbox" ng-model="dash.selection.splitby.jobtype"><label for="jobtype">job type</label>
      </li>
      <li class="list-item"><input id="resourcetype" type="checkbox" ng-model="dash.selection.splitby.resourcetype"><label for="resourcetype">resource type</label>
      </li>
    </ul>
</fieldset>
<div class="medium-1 column">
    <a class="button primary" ng-click="update(dash.selection)">Update</a>
</div>
</div>
</form>
</div>
</div>

<div id="container_rs" style="width: 100%; display: none">
<table id='regionsummary' class="data-table nowrap hover">
  <thead>
  <tr>
      <th class="text">Region</th>
      <th class="text">Job type</th>
      <th class="text">Resource type</th>
      <th class="num">N submitted workers</th>
      <th class="num">N running workers</th>
      <th class="num">N running slots</th>
      <th class="num">N jobs total</th>
      <th class="num">% failure</th>
      {% for js in jobstates %}
          <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
      {% endfor %}
  </tr>
  </thead>
  <tbody>
  </tbody>
  <tfoot>
  <tr>
      <th class="text">Region</th>
      <th class="text">Job type</th>
      <th class="text">Resource type</th>
      <th class="num">N submitted workers</th>
      <th class="num">N running workers</th>
      <th class="num">N running slots</th>
      <th class="num">N jobs total</th>
      <th class="num">% failure</th>
      {% for js in jobstates %}
          <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
      {% endfor %}
  </tr>
  </tfoot>
</table>
</div>

<div id="container_qs" style="width: 100%; display: none">
<table id='queuesummary' class="data-table nowrap hover">
  <thead>
  <tr>
    <th class="text">Queue name</th>
    <th class="text">Queue type</th>
    <th class="text">Region</th>
    <th class="text">Status</th>
    <th class="text">Job type</th>
    <th class="text">Resource type</th>
    <th class="num">N submitted workers</th>
    <th class="num">N running workers</th>
    <th class="num">N running slots</th>
    <th class="num">N jobs total</th>
    <th class="num">% failure</th>
    {% for js in jobstates %}
        <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
    {% endfor %}
  </tr>
  </thead>
  <tbody>
  </tbody>
  <tfoot>
  <tr>
    <th class="text">Queue name</th>
    <th class="text">Queue type</th>
    <th class="text">Region</th>
    <th class="text">Status</th>
    <th class="text">Job type</th>
    <th class="text">Resource type</th>
    <th class="num">N submitted workers</th>
    <th class="num">N running workers</th>
    <th class="num">N running slots</th>
    <th class="num">N jobs total</th>
    <th class="num">% failure</th>
    {% for js in jobstates %}
        <th class="vertical fixed_dash"><div class="rotate70">{{ js }}</div></th>
    {% endfor %}
  </tr>
  </tfoot>
</table>
</div>

{% endblock %}

{% block extra_js %}
<script>

var select_params = {{ selectParams | safe }};
var request_params = {{ requestParams | safe }};
var err_threshold = 15;

app.controller('JobSummaryRegionController', ['$scope', function($scope) {
    $scope.dash = {
        selection: {
            region: '',
            queuetype: '',
            queuestatus: '',
            jobtype: '',
            resourcetype: '',
            splitby: {
                jobtype: false,
                resourcetype: false,
            },
        }
    };

    $scope.dash.availableOptions = {
        region: [{name:'all', value:'', query: ''},],
        queuetype: [{name:'all', value:'', query: ''},],
        queuestatus: [{name:'all', value:'', query: ''},],
        jobtype: [
          {name:'all', value:'', query: ''},
          {name:'analy', value:'analy', query: 'jobtype=analy&'},
          {name:'prod', value:'prod', query: 'jobtype=prod&'},
          {name:'test', value:'test', query: 'jobtype=test&'}
        ],
        resourcetype: [
          {name:'all', value:'', query: ''},
          {name:'SCORE', value:'SCORE', query: 'resourcetype=SCORE&'},
          {name:'SCORE_HIMEM', value:'SCORE_HIMEM', query: 'resourcetype=SCORE_HIMEM&'},
          {name:'MCORE', value:'MCORE', query: 'resourcetype=MCORE&'},
          {name:'MCORE_HIMEM', value:'MCORE_HIMEM', query: 'resourcetype=MCORE_HIMEM&'}
        ],
    };
    select_params.region.forEach(function (param) {
     $scope.dash.availableOptions.region.push({name:param, value:param, query:'region' + param + '&'});
    });

    select_params.queuetype.forEach(function (param) {
     $scope.dash.availableOptions.queuetype.push({name:param, value:param, query:'queuetype' + param + '&'});
    });

    select_params.queuestatus.forEach(function (param) {
     $scope.dash.availableOptions.queuestatus.push({name:param, value:param, query:'queuestatus' + param + '&'});
    });

    Object.keys($scope.dash.availableOptions).forEach(function (key) {
        if (key in request_params && typeof request_params[key] === 'string') {$scope.dash.selection[key] = request_params[key]}
    });
    if ('hours' in request_params) {$scope.dash.selection.hours = parseInt(request_params.hours)}
    if ('splitby' in request_params) {
        if (request_params.splitby.indexOf('jobtype') !== -1) {
            $scope.dash.selection.splitby.jobtype = true
        }
        if (request_params.splitby.indexOf('resourcetype') !== -1) {
            $scope.dash.selection.splitby.resourcetype = true
        }
    }

    $scope.update = function(selection) {
        var query = '{% url 'dashRegion' %}?';
        Object.keys(selection).forEach(function (key) {
            if (key === 'splitby') {
                let subquery = 'splitby=';
                Object.keys(selection.splitby).forEach(function (sbkey) {
                    if (selection.splitby[sbkey] === true) {subquery += sbkey + ','}
                });
                if (subquery.length > 10) {
                    subquery = subquery.substring(0, subquery.length - 1);
                    query += subquery + '&';
                }
            }
            else {
                if (selection[key].toString().length > 0) {
                    query += key + '=' + selection[key].toString() + '&'
                }
            }
        });
        query = query.substring(0, query.length - 1);
        window.location = query;
    };

    $scope.change = function (selection) {
        (selection.jobtype.length > 0) ? $scope.dash.selection.splitby.jobtype = true : $scope.dash.selection.splitby.jobtype = false;
        (selection.resourcetype.length > 0) ? $scope.dash.selection.splitby.resourcetype = true : $scope.dash.selection.splitby.resourcetype = false;
    }
}]);

$(document).ready(function () {
    var regionsummary = {{ regions|safe }};
    var regionsTable = buildRegionSummary(regionsummary, 'regionsummary');
    $('#container_rs').css( 'display', 'block' );
    regionsTable.columns.adjust().draw();
    var queuesummary = {{ queues|safe }};
    var queuesTable = buildQueueSummary(queuesummary, 'queuesummary');
    $('#container_qs').css( 'display', 'block' );
    queuesTable.columns.adjust().draw();
});

function buildRegionSummary(data, divid) {
    var regionsTable = $('#' + divid).DataTable({
        "iDisplayLength": -1,
        "lengthChange": false,
        "paging": false,
        "bFilter": false, // remove search box
        "aaSorting": [[0,'asc']],
        "scrollX": true,
        "autoWidth": true,
        "data": data,
        "buttons": [
          {
            extend: 'colvisGroup',
            text: 'Minimize view',
            hide: [ 3,4,5,8,9,10,12,14,15,17,22,23 ],
          },
          {
            extend: 'colvisGroup',
            text: 'Show details',
            show: ':hidden',
          }
        ],
        "aoColumns": [
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}region=' + row[0] + '">'+row[0]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}jobtype=' + row[1] + '">'+row[1]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "text",
            "render": function(data, type, row, meta) {
                return '<a href = "{{ xurl }}resourcetype=' + row[2] + '">'+row[2]+'</a>'
            }
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
            sDefaultContent: "---",
            className: "num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '">'+row[6]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "alert num",
            render: function (data, type, row, meta) {
              if (data > err_threshold) {
                return '<b>' + data + '</b>'
              }
              else {
                return data
              }
            },
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.0 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.0 }}' + '">'+row[8]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.1 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.1 }}' + '">'+row[9]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.2 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.2 }}' + '">'+row[10]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.3 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.3 }}' + '">'+row[11]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.4 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.4 }}' + '">'+row[12]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.5 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.5 }}' + '">'+row[13]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.6 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.6 }}' + '">'+row[14]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.7 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.7 }}' + '">'+row[15]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.8 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.8 }}' + '">'+row[16]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.9 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.9 }}' + '">'+row[17]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.10 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.10 }}' + '">'+row[18]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.11 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.11 }}' + '">'+row[19]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.12 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.12 }}' + '">'+row[20]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.13 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.13 }}' + '">'+row[21]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.14 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.14 }}' + '">'+row[22]+'</a>';
                return url_link
            }
          },
          {
            sDefaultContent: "---",
            className: "{{ jobstates.15 }}_fill num",
            "render": function(data, type, row, meta) {
                let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}';
                (row[0] === 'all') ? url_link += '': url_link += '&region=' + row[0];
                (row[1] === 'all') ? url_link += '': url_link += '&jobtype=' + row[1];
                (row[2] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[2];
                url_link += '&jobstatus=' + '{{ jobstates.15 }}' + '">'+row[23]+'</a>';
                return url_link
            }
          },
        ],
    });
    regionsTable.columns( [3,4,5,8,9,10,12,14,15,17,22,23] ).visible( false );
    regionsTable.buttons().container()
        .appendTo( '#regionsummary_wrapper .small-6.columns:eq(0)' );
    return regionsTable
}

function buildQueueSummary(data, divid) {
  var queuesTable = $('#' + divid).DataTable({
    "iDisplayLength": 20,
    "lengthMenu": [[10, 20, 50, 100, -1], [10, 20, 50, 100, "All"]],
    "paging": true,
    "aaSorting": [[0,'asc']],
    "scrollX": true,
    "autoWidth": true,
    "data": data,
    "buttons": [
      {
        extend: 'colvisGroup',
        text: 'Minimize view',
        hide: [ 6,7,8,11,12,13,15,17,18,20,25,26 ]
      },
      {
        extend: 'colvisGroup',
        text: 'Show details',
        show: ':hidden'
      }
    ],
    "columns": [
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            let link = '<a href = "{% url 'siteInfo' %}' + row[0] + '/">'+row[0]+'</a>';
            link += ' <a target="_blank" href="https://monit-grafana.cern.ch/d/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite=' + row[0] + '&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1"><div class="tooltip-upper"><img src="/static/images/grafana.png" width=14 height=14 border=0><span class="tooltip-text">Link to Jobs accountig dashboard in Grafana</span></div></a>\n';
            link += ' <a onclick=\'PopUpGrafana("SITE=' + row[0] + '&SIZE=medium", "' + row[0] +  '", "day")\'><div class="tooltip-upper"><img src="/static/images/grafana-black.png" width=14 height=14 border=0><span class="tooltip-text">Slots of running jobs (Pop-up window)</span></div></a>\n';
            if (row[1] == 'production') {
                link += ' <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana#/dashboard/f3042400-aa4d-11ea-88a6-cd72c8759873?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:\'Job%20brokerage\',filters:!((\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4\',key:site.keyword,negate:!f,params:(query:' + row[0] + ',type:phrase),type:phrase,value:' + row[0] + '),query:(match:(site.keyword:(query:' + row[0] + ',type:phrase)))),(\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4\',key:l_type.keyword,negate:!f,params:(query:prod,type:phrase),type:phrase,value:prod),query:(match:(l_type.keyword:(query:prod,type:phrase))))),fullScreenMode:!f,options:(darkTheme:!f,useMargins:!f),panels:!((gridData:(h:2,i:\'4\',w:3,x:0,y:0),id:e9b265f0-6627-11e7-9c82-4bf763932475,panelIndex:\'4\',type:visualization,version:\'6.2.4\'),(gridData:(h:8,i:\'5\',w:12,x:0,y:18),id:c3a4f160-50aa-11e9-a744-833d910adbcf,panelIndex:\'5\',type:visualization,version:\'6.2.4\'),(gridData:(h:6,i:\'6\',w:3,x:0,y:5),id:\'991ce6b0-aa5d-11ea-88a6-cd72c8759873\',panelIndex:\'6\',type:visualization,version:\'6.2.4\'),(gridData:(h:11,i:\'7\',w:9,x:3,y:0),id:\'5c7b65a0-aa5e-11ea-88a6-cd72c8759873\',panelIndex:\'7\',type:visualization,version:\'6.2.4\'),(gridData:(h:7,i:\'8\',w:12,x:0,y:11),id:b7c043e0-aa5e-11ea-88a6-cd72c8759873,panelIndex:\'8\',type:search,version:\'6.2.4\'),(gridData:(h:3,i:\'9\',w:3,x:0,y:2),id:\'6c76ff00-aa68-11ea-88a6-cd72c8759873\',panelIndex:\'9\',type:visualization,version:\'6.2.4\')),query:(language:lucene,query:(query_string:(analyze_wildcard:!t,default_field:\'*\',lowercase_expanded_terms:!f,query:\'*\'))),timeRestore:!t,title:jedilogs_jobbrokerage,viewMode:view)"><div class="tooltip-upper"><img src="/static/images/kibana-logo_full.png" width=14 height=14 border=0><span class="tooltip-text">Link to Brokerage actions (dashboard) in Kibana</span></div></a>\n';
            }
            else if (row[1] == 'analysis')
            {
                link += ' <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana#/dashboard/f3042400-aa4d-11ea-88a6-cd72c8759873?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:\'Job%20brokerage\',filters:!((\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4\',key:site.keyword,negate:!f,params:(query:' + row[0] + ',type:phrase),type:phrase,value:' + row[0] + '),query:(match:(site.keyword:(query:' + row[0] + ',type:phrase)))),(\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4\',key:l_type.keyword,negate:!f,params:(query:analy,type:phrase),type:phrase,value:analy),query:(match:(l_type.keyword:(query:analy,type:phrase))))),fullScreenMode:!f,options:(darkTheme:!f,useMargins:!f),panels:!((gridData:(h:2,i:\'4\',w:3,x:0,y:0),id:e9b265f0-6627-11e7-9c82-4bf763932475,panelIndex:\'4\',type:visualization,version:\'6.2.4\'),(gridData:(h:8,i:\'5\',w:12,x:0,y:18),id:c3a4f160-50aa-11e9-a744-833d910adbcf,panelIndex:\'5\',type:visualization,version:\'6.2.4\'),(gridData:(h:6,i:\'6\',w:3,x:0,y:5),id:\'991ce6b0-aa5d-11ea-88a6-cd72c8759873\',panelIndex:\'6\',type:visualization,version:\'6.2.4\'),(gridData:(h:11,i:\'7\',w:9,x:3,y:0),id:\'5c7b65a0-aa5e-11ea-88a6-cd72c8759873\',panelIndex:\'7\',type:visualization,version:\'6.2.4\'),(gridData:(h:7,i:\'8\',w:12,x:0,y:11),id:b7c043e0-aa5e-11ea-88a6-cd72c8759873,panelIndex:\'8\',type:search,version:\'6.2.4\'),(gridData:(h:3,i:\'9\',w:3,x:0,y:2),id:\'6c76ff00-aa68-11ea-88a6-cd72c8759873\',panelIndex:\'9\',type:visualization,version:\'6.2.4\')),query:(language:lucene,query:(query_string:(analyze_wildcard:!t,default_field:\'*\',lowercase_expanded_terms:!f,query:\'*\'))),timeRestore:!t,title:jedilogs_jobbrokerage,viewMode:view)"><div class="tooltip-upper"><img src="/static/images/kibana-logo_full.png" width=14 height=14 border=0><span class="tooltip-text">Link to Brokerage actions (dashboard) in Kibana</span></div></a>\n';
            }
            else if (row[1] == 'unified')
            {
                link += ' <a target="_blank" href="https://es-atlas.cern.ch/kibana_rw/app/kibana#/dashboard/f3042400-aa4d-11ea-88a6-cd72c8759873?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:\'Job%20brokerage\',filters:!((\'$state\':(store:appState),meta:(alias:!n,disabled:!f,index:\'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4\',key:site.keyword,negate:!f,params:(query:' + row[0] + ',type:phrase),type:phrase,value:' + row[0] + '),query:(match:(site.keyword:(query:' + row[0] + ',type:phrase))))),fullScreenMode:!f,options:(darkTheme:!f,useMargins:!f),panels:!((gridData:(h:2,i:\'4\',w:3,x:0,y:0),id:e9b265f0-6627-11e7-9c82-4bf763932475,panelIndex:\'4\',type:visualization,version:\'6.2.4\'),(gridData:(h:8,i:\'5\',w:12,x:0,y:18),id:c3a4f160-50aa-11e9-a744-833d910adbcf,panelIndex:\'5\',type:visualization,version:\'6.2.4\'),(gridData:(h:6,i:\'6\',w:3,x:0,y:5),id:\'991ce6b0-aa5d-11ea-88a6-cd72c8759873\',panelIndex:\'6\',type:visualization,version:\'6.2.4\'),(gridData:(h:11,i:\'7\',w:9,x:3,y:0),id:\'5c7b65a0-aa5e-11ea-88a6-cd72c8759873\',panelIndex:\'7\',type:visualization,version:\'6.2.4\'),(gridData:(h:7,i:\'8\',w:12,x:0,y:11),id:b7c043e0-aa5e-11ea-88a6-cd72c8759873,panelIndex:\'8\',type:search,version:\'6.2.4\'),(gridData:(h:3,i:\'9\',w:3,x:0,y:2),id:\'6c76ff00-aa68-11ea-88a6-cd72c8759873\',panelIndex:\'9\',type:visualization,version:\'6.2.4\')),query:(language:lucene,query:(query_string:(analyze_wildcard:!t,default_field:\'*\',lowercase_expanded_terms:!f,query:\'*\'))),timeRestore:!t,title:jedilogs_jobbrokerage,viewMode:view)"><div class="tooltip-upper"><img src="/static/images/kibana-logo_full.png" width=14 height=14 border=0><span class="tooltip-text">Link to Brokerage actions (dashboard) in Kibana</span></div></a>\n';
            }
            return link
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}region=' + row[2] + '">'+row[2]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
        render: function(data, type, row, meta) {
            return '<span class="' + row[3] + '">' + row[3] + '</span>'
        }

      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}jobtype=' + row[4] + '">'+row[4]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "text",
        "render": function(data, type, row, meta) {
            return '<a href = "{{ xurl }}resourcetype=' + row[5] + '">'+row[5]+'</a>'
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: function(data, type, row, meta) {
            return '<a href = "{% url 'harvesters' %}?hours=100&status=submitted&computingsite=' + row[0] + '">' + row[6] + '</a>';
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: function(data, type, row, meta) {
          let cellstr = '<a target="_blank" class="';
          let diffpct = 0;
          (row[19] !== 0) ? diffpct = (row[7] - row[19])*100./row[19] : diffpct = 0;
          if (diffpct > 20) {cellstr += 'alert';}
          else if (diffpct > 10) {cellstr += 'warning';}
          cellstr += '" href = "{% url 'harvesters' %}?hours=100&status=running&computingsite=' + row[0] + '">' + row[7] + '</a>';
          return cellstr
        }
      },
      {
        sDefaultContent: "---",
        className: "num",
        render: $.fn.dataTable.render.number( ',', '.'),
      },
      {
        sDefaultContent: "---",
        className: "num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '">'+row[9]+'</a>';
            return url_link
        }
      },
      {
        sDefaultContent: "---",
        className: "alert num",
        render: function (data, type, row, meta) {
          if (data > err_threshold) {
            return '<b>' + data + '</b>'
          }
          else {
            return data
          }
        },
      },
      {
        sDefaultContent: "---",
        className: "{{ jobstates.0 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.0 }}' + '">'+row[11]+'</a>';
            return url_link
        }
      },
      {
        sDefaultContent: "---",
        className: "{{ jobstates.1 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.1 }}' + '">'+row[12]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.2 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.2 }}' + '">'+row[13]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.3 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.3 }}' + '">'+row[14]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.4 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.4 }}' + '">'+row[15]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.5 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.5 }}' + '">'+row[16]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.6 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.6 }}' + '">'+row[17]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.7 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.7 }}' + '">'+row[18]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.8 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.8 }}' + '">'+row[19]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.9 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.9 }}' + '">'+row[20]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.10 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.10 }}' + '">'+row[21]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.11 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.11 }}' + '">'+row[22]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.12 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.12 }}' + '">'+row[23]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.13 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.13 }}' + '">'+row[24]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.14 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.14 }}' + '">'+row[25]+'</a>';
            return url_link
        }
      },
      {
        {#"data": "region",#}
        sDefaultContent: "---",
        className: "{{ jobstates.15 }}_fill num",
        "render": function(data, type, row, meta) {
            let url_link = '<a target="_blank" href = "{% url 'jobList' %}?hours=' + '{{ hours }}' + '&computingsite=' + row[0];
            (row[4] === 'all') ? url_link += '': url_link += '&jobtype=' + row[4];
            (row[5] === 'all') ? url_link += '': url_link += '&resourcetype=' + row[5];
            url_link += '&jobstatus=' + '{{ jobstates.15 }}' + '">'+row[26]+'</a>';
            return url_link
        }
      },
    ],
  });
  queuesTable.columns( [ 6,7,8,11,12,13,15,17,18,20,25,26 ] ).visible( false );
  queuesTable.buttons().container()
    .appendTo( '#queuesummary_wrapper .small-6.columns:eq(0)' );
  return queuesTable
}

var newWinGrafana;
function PopUpGrafana(ref, site) {
    var prt = 'https://';
    var strFeatures="toolbar=no,status=no,menubar=no,location=no,scrollbars=no,resizable=no,height=800,width=1100";
    if (!newWinGrafana || newWinGrafana.closed) {
        newWinGrafana = window.open(ref,'TellObj', strFeatures);
        if (!newWinGrafana.opener) {newWinGrafana.opener = window; }

    newWinGrafana.document.write('<img src="{% url 'grafana' %}?url=https://monit-grafana.cern.ch/render/d-solo/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite='+site+'&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1&panelId=138&width=1000&height=500&tz=Europe%2FBerlin" id="show_image"><p>');
    newWinGrafana.document.close();
    } else {
        if (window.focus) {newWinGrafana.focus()}
    }
}
</script>
{% endblock %}

{% block help %}
<div class="callout success">
  <p>This page summarizes recent job status for regions and queues.</p>
  <p>
  <ul>
  {% if show == 'all' or  job.jobstatus == 'pending' %} <li>  Status <b class='pending'>pending</b> indicates that the job record has been injected into the PanDA DB but PanDA has not yet dealt with it. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'defined' %} <li>  Status <b class='defined'>defined</b> indicates that the job has been received by PanDA and the process of assigning it for execution has begun. {% endif %}
  {% if show == 'all' or job.jobstatus == 'waiting' %} <li>  Status <b class='waiting'>waiting</b> indicates that data handling preparations for the job are underway and have to be completed before the job can be activated. {% endif %}
  {% if show == 'all' or job.jobstatus == 'assigned' %} <li>  Status <b class='assigned'>assigned</b> indicates the job has been assigned to a site and preparations to have the input data ready are underway (e.g. subscriptions, tape staging). {% endif %}
  {% if show == 'all' or  job.jobstatus == 'throttled' %} <li>  Status <b class='throttled'>throttled</b> indicates that dispatch of the job has been postponed due to heavy network use by other jobs. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'activated' %} <li>  Status <b class='activated'>activated</b> indicates that the job is ready to be dispatched to a pilot at the site where it will run. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'sent' %} <li>  Status <b class='sent'>sent</b> indicates that the job was sent to a pilot for execution but the pilot has not yet acknowledged receipt. If this state persists for any length of time, all is not well with the job.{% endif %}
  {% if show == 'all' or  job.jobstatus == 'starting' %} <li>  Status <b class='starting'>starting</b> indicates that the job has been picked up for execution but not yet launched by a pilot on a worker node. Used in environments where pilots don't directly pick up jobs (e.g. Nordugrid). {% endif %}
  {% if show == 'all' or  job.jobstatus == 'running' %} <li>  Status <b class='running'>running</b> indicates that the job is running at its execution site. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'holding' %} <li>  Status <b class='holding'>holding</b> indicates that the job has completed but output validation and processing (eg. registering outputs in datasets) is still underway. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'transferring' %} <li>  Status <b class='transferring'>transferring</b> indicates that transferring of outputs to their final destination after job completion is underway. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'merging' %} <li>  Status <b class='transferring'>merging</b> indicates that job is waiting while the correspondent merge job is done and merged files are transferred to the final destination. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'finished' %} <li>  Status <b class='finished'>finished</b> indicates that the job has successfully completed. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'failed' %} <li>  Status <b class='failed'>failed</b> indicates that the job has failed at some stage. Information on where the error occurred and with what error condition can be found in the job parameters table. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'cancelled' %} <li>  Status <b class='cancelled'>cancelled</b> indicates that the job has been cancelled, either by the user or by the system. Further information may be available in the job parameters table. {% endif %}
  {% if show == 'all' or  job.jobstatus == 'closed' %} <li>  Status <b class='closed'>closed</b> terminated by the system before completing the allocated workload. E.g., killed to be reassigned to another site.{% endif %}
  </ul>
  </p>

</div>
{% endblock %}






