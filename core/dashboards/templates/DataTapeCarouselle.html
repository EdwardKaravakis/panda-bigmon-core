{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}

{% block page_title %}Data Tape Carousel DashBoard{% endblock %}
{% block subtitle %}Data Tape Carousel DashBoard <font size=-1>{{ viewParams.selection|safe }}</font> {% endblock %}


{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static '/css/wizardstyles.css'%}" />
{% endblock %}
{% block extra_js %}
    <script src="{% static 'js/hideCells.js' %}"></script>
    <script src="{% static 'js/jquery.floatThead.min.js' %}"></script>
{% endblock %}

{% block body %}
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['sankey','corechart']}]}"></script>
    <script type="text/javascript">

        var app = angular.module('dataviewapp', []).config(function ($interpolateProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');
        })
            .config(['$compileProvider', function ($compileProvider) {
        $compileProvider.debugInfoEnabled(false);
        }])
            .service('Service', ['$http', service])
            .controller('dataviewctrl', ['$scope','Service', controller]);

        function service($http, $scope){
            var get = function(requestparams) {
             return $http({
              method: 'GET',
              url: '{% url 'getDTCSubmissionHist' %}'+requestparams,
              cache: false
            })};
            return {
              get: get
            }
        }

        function controller($scope, Service){

            $scope.gog = function(){
                var request = "";
                if ($scope.selectedTime == "hours720") request = '?hours=720';
                if ($scope.selectedTime == "hours168") request = '?hours=168';
                if ($scope.selectedTime == "hours24") request = '?hours=24';
                if ($scope.selectedTime == "hours12") request = '?hours=12';
                if ($scope.selectedTime == "hours1") request = '?hours=1';

                if (request.length == 0) request = "?"; else request += "&";
                if ($scope.selectedCampaign) request += ('campaign=' + $scope.selectedCampaign);
                if (request.length == 0) request = "?"; else request += "&";
                if ($scope.selectedSource) request += ('source=' + $scope.selectedSource);

                Service.get(request).then($scope.processResponce);
            };


            $scope.updateByTime = function(){
               if ($scope.selectedTime == "hours720") Service.get('?hours=720').then($scope.processResponce);
               if ($scope.selectedTime == "hours168") Service.get('?hours=168').then($scope.processResponce);
               if ($scope.selectedTime == "hours24") Service.get('?hours=24').then($scope.processResponce);
               if ($scope.selectedTime == "hours12") Service.get('?hours=12').then($scope.processResponce);
               if ($scope.selectedTime == "hours1") Service.get('?hours=1').then($scope.processResponce);
            };


            var optionsACTCH = {
                          title: 'Activation time',
                          legend: { position: 'none' },
                          hAxis: {title: 'Time', titleTextStyle: {color: 'black'},  textStyle: { fontSize:11},},
                          explorer: {
                            actions: ['dragToZoom', 'rightClickToReset'],
                            axis: 'horizontal',
                            keepInBounds: true,
                            maxZoomIn: 4.0
                          },
                      };
            var chartACTCH = new google.visualization.ColumnChart(document.getElementById('chartACTCH_div'));
            var chartETCH = new google.visualization.Histogram(document.getElementById('chartETCH_div'));
            var optionsETCH = {
                          title: 'Elapsed time (h)',
                          legend: { position: 'none' },
                          hAxis: {title: 'Time (h)', titleTextStyle: {color: 'black'},  textStyle: { fontSize:11},},
                          explorer: {
                            actions: ['dragToZoom', 'rightClickToReset'],
                            axis: 'horizontal',
                            keepInBounds: true,
                            maxZoomIn: 4.0
                          },
histogram: {
                        bucketSize: .01
                    }
                      };

            var chartPRCH = new google.visualization.Histogram(document.getElementById('chartPRCH_div'));
            var optionsPRCH = {
                          title: 'Progress of active stagings (%)',
                          legend: { position: 'none' },
                          hAxis: {title: 'Progress (%)', titleTextStyle: {color: 'black'},  textStyle: { fontSize:11},},
                          explorer: {
                            actions: ['dragToZoom', 'rightClickToReset'],
                            axis: 'horizontal',
                            keepInBounds: true,
                            maxZoomIn: 4.0
                          },
histogram: {
                        bucketSize: .1
                    }
            };

            $scope.processResponce = function(response) {
                response.data.submittime = response.data.submittime.map(function (row) {
                   return [
                   new Date(row[0]),
                            row[1]
                      ];
                   });
                 var dataACTCH = google.visualization.arrayToDataTable(response.data.submittime);
                 chartACTCH.draw(dataACTCH, optionsACTCH);

                 var dataETCH = google.visualization.arrayToDataTable(response.data.epltime);
                 chartETCH.draw(dataETCH, optionsETCH);

                 var dataPRCH = google.visualization.arrayToDataTable(response.data.progress);
                 chartPRCH.draw(dataPRCH, optionsPRCH);

                 $scope.progresstablearr = response.data.progresstable;
                 $scope.selecttime = response.data.selecttime;
                 $scope.selectedTime = {};
                 for (item of $scope.selecttime) {
                     if (item.selected == "1") $scope.selectedTime = item.value;
                     console.error(item.value);
                 }


                 $scope.selectedCampaign = null;
                 $scope.selectedSource = null;

                 $scope.selectcampaign = response.data.selectcampaign;
                 $scope.selectsource = response.data.selectsource;
            }
            Service.get('').then($scope.processResponce);
        }
    </script>

    <style>
        .panel {
            width: 600px;
            height: 500px;
        }
    </style>


    <div class="large-12 columns" ng-app="dataviewapp" data-ng-controller="dataviewctrl">
     <div class="row">
        <div id="chartACTCH_div" class="column column-block panel" ></div>
         <div id="selectionpane" class="column column-block medium-4" style="margin-top: 60px">
            <select id="timewindow" ng-model="selectedTime" ng-options="timeitem.value as timeitem.name for timeitem in selecttime" ng-change="updateByTime();">
               <option value="" disabled>Select Time Window</option>
            </select>

            <b>Campaign:</b>
            <select id="campaign" ng-model="selectedCampaign" ng-options="campitem.value as campitem.name for campitem in selectcampaign" multiple>
                <option value="" selected="selected">All</option>
            </select>

            <b>Source:</b>
            <select id="source" ng-model="selectedSource" ng-options="source.value as source.name for source in selectsource" multiple>
               <option value="" selected="selected">All</option>
            </select>
            <a ng-click="gog();" class="button primary">Update</a>
         </div>
     </div>



     <div class="row">
         <div id="chartETCH_div" class="column column-block panel" ></div>
         <div id="chartPRCH_div" class="column column-block panel" ></div>
     </div>
     <div class="row">
        <div class="column small-offset-7 medium-centered">
            <table id="transfersmatrix" class="unstriped errorsscat floatThead">
              <thead>
                <tr>
                    <th>Source</th>
                    <th>Datasets Active</th>
                    <th>Datasets Done <br>(+ 90% readiness)</th>
                    <th>Files Remaining</th>
                    <th>Files Done</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="x in progresstablearr" class="low-stat">
                    <th class="sm_ok_fill"> <a href="{% url 'taskList' %}?tape=true&source={$ x.source $}">{$ x.source $}</a></th>
                    <td class="sm_ok_light_fill">
                        {$ x.ds_active $}
                    </td>
                    <td class="sm_ok_light_fill">
                        {$ x.ds_done $} (+{$ x.ds_90pdone $})
                    </td>
                    <td class="sm_ok_light_fill">
                        {$ x.files_rem $}
                    </td>
                    <td class="sm_ok_light_fill">
                        {$ x.files_done $}
                    </td>
                </tr>
              </tbody>
            </table>
        </div>
     </div>
    </div>

{% endblock %}

