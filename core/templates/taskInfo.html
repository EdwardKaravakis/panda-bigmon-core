{% extends "_base_core.html" %}
{% load static %}{% load common_tags %}{% load humanize %}
{% block page_title %} {{ jeditaskid }} task  {% endblock %}
{% block css_page_library %}
  <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
  <!-- Load c3.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.css" rel="stylesheet">
{% endblock %}
{% block js_head_page_library %}
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
  <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
  <!-- Load d3.js and c3.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.js"></script>
{% endblock %}

{% block subtitle %}{% if jeditaskid > 0 %}{{ jeditaskid }} task:{% endif %} <b>{{ task.taskname }}</b>{% endblock %}

{% block body %}

{% if columns %}
  <div class="table-scroll">
  <table class="fresh-table unstriped" data-ng-app="" data-ng-controller="iDDSGeneralInfo">
    <thead>
      <tr>
        <th colspan=20> {{ jeditaskid }} task: {{ taskname }} </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Task ID</th>
        {% if task.campaign %}
            <th> Campaign</th>
        {% endif %}
        {% if task.deftreqid %}
            <th> Request</th>
        {% endif %}
        {% if task.reqid != task.jeditaskid and not task.deftreqid %}
            <th>Jobset</th>
        {% endif %}
        <th>Type</th>
        <th>Processing type</th>
        {% if task.workinggroup %}
          <th>Working Group</th>
        {% endif %}
        <th>User</th>
        <th>Destination</th>
        <th>Nucleus</th>
        <th>Task status</th>
        {% if task.superstatus and task.superstatus != task.status %}
            <th> Detailed JEDI status</th>
        {% endif %}
        {% if task.idds_info and task.idds_info.task_type == 'hpo' %}
            <th class="num"> HP points
              <br><span class='finished'>finished</span></th>
            {% if task.dsinfo %}
              <th class="num">HS06*sec
                <br><span class="closed">Expected</span>
                <br> Total<br><span class='done'>done</span>
                <br> <span class='failed'>failed</span>
              </th>
            {% endif %}
        {% else %}
          {% if task.dsinfo %}
            <th class="num"> Nevents  <br><span class='finished'>used</span></th>
            <th class="num">HS06*sec
                <br> <span class="closed">Expected</span>
                <br> Total<br><span class='done'>done</span>
                <br> <span class='failed'>failed</span>
            </th>
            <th class="num"> Ninputfiles
                <br><span class='finished'>finished</span>
                <br><span class='failed'>failed</span>
            </th>
          {% endif %}
        {% endif %}
        <th>Time stamps:
          <br><span class="defined">created</span>
          <br><span class="activated">started</span>
          <br><span class="closed">last modified</span>
        </th>
        <th>Cores</th>
        <th>Priority</th>
        <th>Parent</th>
        {% if task.ticketid %}
            <th>Tracker</th>
        {% endif %}
      </tr>
      <tr>
        <td><a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/"
               target="_blank">{{ task.jeditaskid }}</a></td>
        {% if task.campaign %}
            <td><a href='/tasks/?campaign={{ task.campaign }}'>{{ task.campaign }}</a></td>
        {% endif %}
        {% if task.deftreqid %}
            <td><a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/{{ task.deftreqid }}/"
                   target="_blank">{{ task.deftreqid }}</a></td>
        {% endif %}
        {% if task.reqid != task.jeditaskid and not task.deftreqid %}
            <td>{{ task.reqid }}</td>
        {% endif %}
        <td>{% if task.tasktype == 'anal' %} analy {% else %} {{ task.tasktype }} {% endif %}</td>
        <td>{% if task.processingtype %} {{ task.processingtype }} {% endif %} </td>
        {% if task.workinggroup %}
          <td> {{ task.workinggroup }} </td>
        {% endif %}
        <td><a href="{% url 'taskList' %}?username={{ task.username }}">{{ task.username }}</a></td>
        <td>{% if task.destination %}{{ task.destination }}{% else %}&mdash;{% endif %}</td>
        <td>{% if task.nucleus %}{{ task.nucleus }}{% else %}&mdash;{% endif %}</td>
        <td class='{{ task.status }}_fill'>
          {% if task.superstatus %}
            <a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
                  class="bp_tooltip task_{{ task.superstatus }}">{{ task.superstatus }}</a>
          {% else %}
            <a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
               class="bp_tooltip task_{{ task.status }}"><b>{{ task.status }}</b></a>
          {% endif %}
        </td>
        {% if task.superstatus and task.superstatus != task.status %}
          <td class='{{ task.status }}_fill'>
            <a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
               class="bp_tooltip task_{{ task.status }}"><b>{{ task.status }}</b></a>
          </td>
        {% endif %}
        {% if task.idds_info and task.idds_info.task_type == 'hpo' %}
          <td class="num">
            <div ng-show="loading">LOADING...</div>
            <div ng-cloak ng-show="!loading">
              <span ng-bind="iddsjson.out_total_files">
                <span>{$ iddsjson.out_total_files $}</span>
              </span>
{#              <span>{$ iddsjson.out_total_files $}</span>#}
              <br><span class='finished'><span>{$ iddsjson.out_total_files $}</span> (<span>{$ iddsjson.pctprocessed $}</span>%) </span>
            </div>
          </td>

          {% if task.dsinfo %}
            <td class="num"> <span class="closed">{% if task.totevhs06 %}{{ task.totevhs06 | intcomma }}{% else %}&mdash;{% endif %}</span>
              <br>{{ task.currenttotevhs06 | intcomma }}
              <br><span class='finished'>{{ task.totevprochs06 | intcomma }}</span>
              <br><span class='failed'>{{ task.failedevprochs06 | intcomma }}</span>
            </td>
          {% endif %}
        {% else %}
          {% if task.dsinfo %}
            <td class="num"> {{ task.totev | intcomma }}
              <br><span class='finished'>{{ task.totevproc | intcomma }} ({{ task.pctfinished|floatformat }}%)</span>
            </td>
            <td class="num"> <span class="closed">{% if task.totevhs06 %}{{ task.totevhs06 | intcomma }}{% else %}&mdash;{% endif %}</span>
              <br>{{ task.currenttotevhs06 | intcomma }}
              <br><span class='finished'>{{ task.totevprochs06 | intcomma }}</span>
              <br><span class='failed'>{{ task.failedevprochs06 | intcomma }}</span>
            </td>
            <td class="num"> {{ task.dsinfo.nfiles }}
              <br><span class='finished'>{{ task.dsinfo.nfilesfinished }} ({{ task.dsinfo.pctfinished|floatformat }}%)</span>
              {% if task.dsinfo.nfilesfailed > 0 %}
                <br><span class='failed'>{{ task.dsinfo.nfilesfailed }} ({{ task.dsinfo.pctfailed|floatformat }}%)</span>
              {% endif %}
            </td>
          {% endif %}
        {% endif %}
        <td>{% if task.creationdate %}<span class="defined">{{ task.creationdate }}</span>{% else %}&mdash;{% endif %}
          <br>{% if task.starttime %}<span class="activated">{{ task.starttime }}</span>{% else %}&mdash;{% endif %}
          <br>{% if task.modificationtime %}<span class="closed">{{ task.modificationtime }}</span>{% else %}&mdash;{% endif %}
        </td>
        <td>{{ task.corecount }}</td>
        <td>{{ task.taskpriority }}</td>
        <td>
          {% if task.parent_tid and task.parent_tid != task.jeditaskid %}
            <a href="{% url 'taskInfo' task.parent_tid %}">{{ task.parent_tid }}</a>
          {% else %}&mdash;{% endif %}
        </td>
        {% if task.ticketid %}
            <td><a href="https://its.cern.ch/jira/browse/{{ task.ticketid }}">{{ task.ticketsystemtype }}</a>
            </td>
        {% endif %}
      </tr>
    </tbody>
  </table>
  </div>

  {% if task.errordialog %}
    <div class="card bp-container-simple warning">
      {% if logtxt %}
        <div class="card-divider">
          <h5>Logged status: {{ task.errordialog|safe }}</h5>
        </div>
        <div class="card-section scrollable">
          <pre>
          {{ logtxt }}
          </pre>
        </div>
      {% else %}
        <div class="card-divider errorlog">
          <h5>Logged status: {{ task.errordialog|safe }}</h5>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <div class="bp-container-wrapper">
  <div class="bp-dropdown-button">
      <button class="dropdown">Task extra info</button>
      <div class="dropdown-items">
          {% if requestParams.mode and requestParams.mode == 'nodrop' %}
              <a href="{{ nomodeurl }}mode=drop">Switch to drop mode</a>
          {% else %}
              <a href="{{ nomodeurl }}mode=nodrop">Switch to nodrop mode</a>
          {% endif %}
          {% if vomode == 'atlas' %}
              {% if task.tasktype == 'prod' %}
                  <a href="https://prodtask-dev.cern.ch/prodtask/task_manage/#/?time_period=custom&task_type=production&task_id={{ task.jeditaskid }}"
                     target="_blank">Manage Prod Task</a>
                  <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/">Prod Task page</a>
              {% elif  task.tasktype == 'anal' %}
                  <a href="https://prodtask-dev.cern.ch/prodtask/task_manage/#/?time_period=custom&task_type=analysis&task_id={{ task.jeditaskid }}"
                     target="_blank">Manage Prod Task</a>
                  <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/">Prod Task page</a>
              {% endif %}
              <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,logLevel,message),filters:!(),index:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'fields.type:%22atlasprodtaskbroker%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc&type=histogram">Task
                  brokerage </a>
              <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,message),filters:!(),index:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'fields.type:%22{% if task.brokerage == 'prod_brokerage' %}atlasprodjobbroker{% else %}atlasanaljobbroker{% endif %}%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc&type=histogram">Job
                  brokerage </a>
              <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,logLevel,message),index:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc))">Action
                  logger</a>
              <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',logName,fields.type,logLevel,message),index:'620eaaf0-bfac-11ea-b7f2-27bdf2c0b5dc',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'logName.keyword:%22panda.log.RetrialModule%22%20AND%20fields.type:%22retrialmodule%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',desc))">Retrial
                  Module logger</a>
          {% endif %}
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'errorSummary' %}?jeditaskid={{ jeditaskid }}">Error summary</a>
          {% if task.parent_tid != task.jeditaskid and task.parent_tid != None %}
              <a href="{% url 'taskInfo' task.parent_tid %}">Parent task {{ task.parent_tid }}</a>
          {% endif %}
          <a href="{% url 'taskList' %}?parent_tid={{ task.jeditaskid }}&display_limit=100">Child tasks</a>
          {% if task.ttcrequested != None and task.starttime != None %}
              <a href="{% url 'ttc' %}?jeditaskid={{ jeditaskid }}" target="_blank">TTC page</a>
          {% endif %}
      </div>
  </div>

  <div class="bp-dropdown-button">
    <button class="dropdown">Show jobs</button>
    <div class="dropdown-items">
      <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=nodrop&display_limit=100">All (including retries)</a>
      <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=drop&display_limit=100">All (retries dropped)</a>
      <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&specialhandling=sj">Scouts</a>
      <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=finished|failed|cancelled">Ended</a>
      <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=defined|waiting|pending|assigned|throttled|activated|sent|starting|running|holding|transferring">Active</a>

    </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Task parameters and help</button>
      <div class="dropdown-items">
          <a onclick="loadStatusLog('{{ jeditaskid }}')">Show task status log</a>
          <a href="#jobparams">Jump to job parameters</a>
          {% if jobscoutids|length > 0 %}
              <a href="#scouts">Jump to scout jobs</a>
          {% endif %}
          {% if taskparams %}
              <a href="#taskparamsprodsys">Jump to ProdSys task parameters</a>
          {% endif %}
          <a href="#taskparamsjedi">Jump to PanDA/JEDI task parameters</a>
          <a href="#help">Jump to help</a>
      </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Memory & walltime usage</button>
      <div class="dropdown-items">
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="#plots" onclick="togglePlots();">Memory and walltime usage</a>
          <a href="http://atlas-kibana-panda.mwt2.org:5601/app/kibana#/dashboard/BP_a_task?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:absolute,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:BP_Walltime_all_jobs,panelIndex:1,row:1,size_x:6,size_y:3,type:visualization),(col:7,id:BP_Walltime_failed_jobs,panelIndex:2,row:1,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_all_jobs,panelIndex:3,row:4,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_failed_jobs,panelIndex:4,row:4,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_per_core_all_jobs,panelIndex:5,row:7,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_per_core_failed_jobs,panelIndex:6,row:7,size_x:6,size_y:3,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_a_task,uiState:(P-1:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!t))))"
             target="_blank"><span class="tooltip-upper">Memory and walltime usage (Kibana)<span class="tooltip-text">This Kibana instance is read-only. If you do not have access please contact Ilija Vukotic [ivukotic@cern.ch].</span></span></a>
      </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Other plots</button>
      <div class="dropdown-items">
          {% if not task.tasktype == 'anal' %}
              <a href="{% url 'ganttTaskChain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Gantt diagram)</a>
              <a href="{% url 'taskchain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Tree diagram)</a>
          {% endif %}
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'taskProfileMonitor' task.jeditaskid %}" target="_blank">Task Profile</a>
          <a href="http://atlas-kibana-panda.mwt2.org:5601/app/kibana#/dashboard/9058c590-200d-11e7-84dc-8d3ed2710506?_g=(filters:!(),refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:'3f4fa5d0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:1,row:1,size_x:3,size_y:3,type:visualization),(col:4,id:'94d395c0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:3,row:1,size_x:5,size_y:4,type:visualization),(col:1,id:'88c1ea50-2003-11e7-983d-8109a2d43cab',panelIndex:4,row:5,size_x:6,size_y:5,type:visualization),(col:9,id:c3a6e3c0-2001-11e7-a8cf-1bce3a1c32b4,panelIndex:5,row:1,size_x:4,size_y:4,type:visualization),(col:7,id:'88e76c50-2006-11e7-983d-8109a2d43cab',panelIndex:6,row:5,size_x:6,size_y:5,type:visualization),(col:1,id:b2c68750-2005-11e7-983d-8109a2d43cab,panelIndex:7,row:10,size_x:5,size_y:3,type:visualization),(col:6,id:f0d9a450-2005-11e7-983d-8109a2d43cab,panelIndex:8,row:10,size_x:6,size_y:3,type:visualization),(col:1,id:c9e1f1d0-2006-11e7-983d-8109a2d43cab,panelIndex:9,row:13,size_x:2,size_y:3,type:visualization),(col:3,id:'7c88d960-2008-11e7-983d-8109a2d43cab',panelIndex:10,row:13,size_x:10,size_y:3,type:visualization),(col:9,id:'12a10860-2008-11e7-983d-8109a2d43cab',panelIndex:12,row:16,size_x:4,size_y:3,type:visualization),(col:5,id:'0b3a75d0-2007-11e7-983d-8109a2d43cab',panelIndex:13,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:'52964850-2007-11e7-983d-8109a2d43cab',panelIndex:14,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:b07c2fe0-200a-11e7-983d-8109a2d43cab,panelIndex:15,row:19,size_x:12,size_y:4,type:visualization),(col:1,id:'039a7c60-2009-11e7-983d-8109a2d43cab',panelIndex:16,row:23,size_x:12,size_y:5,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_ES_task,uiState:(P-1:(vis:(legendOpen:!f)),P-10:(vis:(legendOpen:!f)),P-13:(vis:(legendOpen:!f)),P-14:(vis:(legendOpen:!f)),P-15:(vis:(legendOpen:!f)),P-16:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!f)),P-3:(vis:(legendOpen:!f)),P-4:(vis:(legendOpen:!f)),P-5:(vis:(legendOpen:!f)),P-6:(vis:(legendOpen:!f)),P-7:(vis:(legendOpen:!f)),P-8:(vis:(legendOpen:!f)),P-9:(vis:(legendOpen:!f))))"
             target="_blank"><span class="tooltip-upper">ES task dashboard (Kibana)<span class="tooltip-text">This Kibana instance is read-only. If you do not have access please contact Ilija Vukotic [ivukotic@cern.ch].</span></span></a>
      </div>
  </div>

  {% with 'done finished failed ready broken aborted defined' as finalstatelist %}
      {% if not task.status in finalstatelist %}
          <div style="float: right">
              <a onclick="killtasks({{ task.jeditaskid }}, 0);" class='bp-button kill'>Finish</a>
              <a onclick="killtasks({{ task.jeditaskid }}, 1);" class='bp-button kill'>Abort</a>
          </div>
      {% endif %}
  {% endwith %}
  </div>

  {% if warning.dropmode %}
      <div class="callout warning" data-closable>
        <h5>Warning! </h5>
        <p>{{ warning.dropmode }}</p>
          <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
              <span aria-hidden="true">&times;</span>
        </button>
      </div>
  {% endif %}

  {% if jobsummary %}
    {% if requestParams.warning %}
      <div class="callout small alert">
        <p style="color:brown">{{ requestParams.warning }}</p>
      </div>
    {% endif %}
    <div class="table-scroll">
    <table class="fresh-table unstriped">
      <thead>
        <tr>
            <th colspan=20>
                <b>States of jobs in this task {% if mode %}[{{ mode }} mode]{% endif %}</b>
            </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th></th>
            {% for state in jobsummary.0.job_state_counts %}
              <th class="{{ state.name }}"><b> {{ state.name }} </b></th>
            {% endfor %}
        </tr>
        {% for job_category_states in jobsummary %}
          <tr>
            <th>{{ job_category_states.value | title }}</th>
            {% for state in job_category_states.job_state_counts %}
              <td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}>
                    {% if state.count > 0 %}
                        <b> <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus={{ state.name }}&mode={{ mode }}{% if job_category_states.value == 'build' %}&transformation=build*{% elif job_category_states.value == 'merge' %}&processingtype=pmerge{% else %}&processingtype=!pmerge&prodsourcelabel={% if task.tasktype == 'prod' %}managed{% else %}user{% endif %}{% endif %}&display_limit=100">
                            <span class='{{ state.name }}_fill'>{% if state.count > 0 %} {{ state.count }} {% endif %}</span></a> </b>
                    {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <div class="card bp-container-simple info">
      <div class="card-divider">
        <p>No jobs were found for the task</p>
      </div>
    </div>
  {% endif %}

  {% if jobscoutids|length > 0 %}
    <table class="fresh-table unstriped">
      <tbody>
        <tr>
          <th><b> Scout jobs: </b></th>
          {% for scout_metric, pandaids in jobscoutids.items %}
            <td><b>{{ scout_metric }}:</b>
              {% for job in pandaids %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a>{% if forloop.last %}{% else %}, {% endif %}
              {% endfor %}
            </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  {% endif %}

  {% if warning.memoryleaksuspicion %}
      <p></p>
      <div class="callout warning" data-closable>
        <h5>Warning! {{ warning.memoryleaksuspicion.message }}</h5>
        <p>At least one of jobs in this task consumed more max PSS/core than it is limited by a computing site. Please check the next top memory consumed jobs and their memory and IO usage plots: </p>
        <ul>
        {% for job in warning.memoryleaksuspicion.jobs %}
          <li style="font-size: smaller"> <a class="blacklink bold hover" href="{% url 'jobInfo' job.pandaid %}">{{ job.pandaid }}</a> job consumed {{ job.jobmaxpss_percore }} MB per core out of {{ job.sitemaxrss_percore }} MB per core limited by <a class="blacklink bold hover" href="{% url 'siteInfo' job.computingsite %}">{{ job.computingsite }}</a>, see <a class="blacklink bold hover" target="_blank" href="{% url 'prMonPlots' job.pandaid %}">plots</a>
        {% endfor %}
        </ul>
        <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
              <span aria-hidden="true">&times;</span>
        </button>
      </div>
  {% endif %}

  <div id="div-statuslog"></div>

  <div id="plots" data-ng-controller="jobConsumptionPlotsController">
  <div class="card bp-container-simple secondary" ng-hide="taskinfo.jc_plots.selection.is_hidden">
    <div class="card-divider"><p>Job consumption plots:</p></div>
    <div class="card-section">

      <fieldset class="inline">
        <legend>Job category:</legend>
        <label ng-repeat="option in taskinfo.jc_plots.options.category"><input type="radio" ng-value="option" ng-model="taskinfo.jc_plots.selection.category" ng-change="taskinfo.jc_plots.rebuild()">{$ option $}</label>
      </fieldset>

      <div class="c3-chart-block" ng-repeat="plot in taskinfo.jc_plots.plot_data" jcplot-directive plot="plot" parent="$parent"></div>
    </div>
  </div>
  </div>

  <div id="dsStageDiv" class="fresh-table badevents" ng-app="taskInfoAppAJS" ng-controller="StagingDSController" style="display:none;">
  <table>
    <thead>
      <tr><th colspan=20>Dataset staging information</th></tr>
    </thead>
    <tbody>
      <tr>
           <th>Staged / Total files <a target="_blank" href="{% url 'staginprogressplot' %}?jeditaskid={{ jeditaskid }}"><i class="fi-graph-trend"></i></a></th>
           <td>{$ json['staged_files'] $} / {$ json['total_files'] $}</td>
      </tr>
      <tr ng-repeat="(key, value) in json" ng-if="key!='staged_files' && key!='total_files' && key!='taskid'">
           <th>{$ key $}</th>
           <td>{$ value $}</td>
      </tr>
    </tbody>
  </table>
  </div>

  {% if task.idds_info %}
    <div id="iDDsDiv" class="badevents" ng-app="iDDsInfoAppAJS" ng-controller="iDDSInfoForTaskController" style="display:none;">
      <table class="fresh-table">
        <thead>
          <tr><th colspan=20>iDDS information</th></tr>
        </thead>
        <tbody>
          <tr ng-repeat="(key, value) in iddsjson" ng-if="key!='staged_files' && key!='total_files' && key!='taskid'">
             <th>{$ key $}</th>
             <td>{$ value $}</td>
          </tr>
        </tbody>
      </table>
    </div>
  {% endif %}

  {% if inctrs or outctrs %}
    <table class="fresh-table unstriped">
    <thead>
      <tr><th colspan=20>Containers</th></tr>
    </thead>
    <tbody>
      {% if inctrs %}
        <tr><th>Input:</th></tr>
        {% for dsrec in inctrs %}
          <tr>
              <td class="wrap-words"><a href="{% url 'datasetList' %}?containername={{ dsrec }}">{{ dsrec }}</a></td>
          </tr>
        {% endfor %}
      {% endif %}
      {% if outctrs %}
        <tr><th>Output:</th></tr>
        {% for dsrec in outctrs %}
          <tr>
              <td class="wrap-words"><a href="{% url 'datasetList' %}?containername={{ dsrec }}">{{ dsrec }}</a></td>
          </tr>
        {% endfor %}
      {% endif %}
    </tbody>
    </table>
  {% endif %}

  {% if datasets %}
    <div class="card bp-container-simple secondary" id="container_dst">
    <div class="card-divider"><p>Dataset processing information:</p></div>
    <div class="card-section">
      <table class="data-table left-aligned nowrap" id="datasetstable">
          <thead>
          <tr>
              <th>Dataset, container name</th>
              <th>Type</th>
              <th>Stream</th>
              <th>Status</th>
              <th>Nfiles</th>
              <th>Nfiles finished</th>
              <th>Nfiles failed</th>
              <th>%</th>
              <th>Links</th>
          </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>
    </div>
  {% else %}
      <p>No datasets were found for this task</p>
  {% endif %}


  {% if jobparams %}
    <a name="jobparams"></a>
    <table class="fresh-table">
      <thead>
        <tr><th colspan=20> Job parameters</th></tr>
      </thead>
      <tbody>
        {% for p in jobparams %}
            <tr>
                <td class="wrap-words">{{ p|safe }}</td>
            </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}


  {% if taskparams %}
    <a name="taskparamsprodsys"></a>
    <table class="fresh-table">
      <thead>
        <tr><th colspan=20> Prodsys task parameters</th></tr>
      </thead>
      <tbody>
        {% for p in taskparams %}
            {% if p.name != 'jobParameters' and p.name != 'log' %}
                <tr>
                    <td class="bold">{{ p.name }}</td>
                    <td class="wrap-words">{% if p.value %} {{ p.value }} {% else %}&mdash;{% endif %}</td>
                </tr>
            {% endif %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <a name="taskparamsjedi"></a>
  <table  class="fresh-table">
    <thead>
      <tr>
          <th colspan=20> PanDA/JEDI task parameters</th>
      </tr>
    </thead>
    <tbody>
      {% for col in columns %}
          <tr>
              <td class="bold">{{ col.name }}</td>
              <td class="wrap-words">
                {% if col.value %}
                  {% if col.name == 'cputimescoutjob' %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ col.value }}">{{ col.value }}</a>
                  {% else %}
                    {{ col.value }}
                  {% endif %}
                {% else %} &mdash;
                {% endif %}
              </td>
          </tr>
      {% endfor %}
    </tbody>
  </table>

{% else %}

  <p>PanDA task {% if jeditaskid > 0 %}{{ jeditaskid }}{% endif %} {% if task.taskname %}:<b>{{ task.taskname }}</b> not found.{% endif %}</p>
  {% if viewParams.MON_VO == 'ATLAS' %}
    <p>You can however get a job listing for any task in quick search.</p>
  {% endif %}

{% endif %}

{% endblock %}

{% block js_body_page %}
<script src="{% static 'js/draw-plots-c3.js' %}?{% cache_bust "js/draw-plots-c3.js" %}"></script>
<script>
    app.controller('iDDSInfoForTaskController', function ($scope, $http, $rootScope) {
        $scope.iddsjson = "";
        $scope.getiDDs = function () {
                $http({
                        url: '/idds/getiddsfortask/',
                        method: "GET",
                        params: {'jeditaskid':{{ jeditaskid|safe }}}
                    }
                ).then(function (res) {
                    var iddsjson = angular.fromJson(res.data);
                    if (('data' in iddsjson) && (Object.keys(iddsjson['data']).length > 0)) {
                        $scope.iddsjson = iddsjson['data'];
                        idds_data = iddsjson['data'];
                        $rootScope.$emit('idds_info', idds_data);
                        $('#iDDsDiv').show();
                    }
                });
        };
        var init = function () {
            $scope.getiDDs();
        };
        init();
    });
    app.controller('iDDSGeneralInfo', function($rootScope, $scope) {
        $scope.loading = true;
        $rootScope.$on('idds_info', function(event, data) {
            $scope.iddsjson = data;
            console.log(data);
            $scope.loading = false;
        });
    });
    app.controller('StagingDSController', function ($scope, $http) {
        $scope.json = "";
        $scope.getStagingDS = function () {

            $http({
                    url: '/getstaginginfofortask/',
                    method: "GET",
                    params: {'jeditaskid':{{ jeditaskid|safe }}}
                }
            ).then(function (res) {
                $scope.json = angular.fromJson(res.data);
                if  ({{ jeditaskid|safe }} in $scope.json) {
                    var displaydiv = document.getElementById('dsStageDiv');
                    displaydiv.style.display = "";
                    $scope.json = $scope.json[{{ jeditaskid|safe }}];
                }
            });
        };
        var init = function () {
            $scope.getStagingDS();
        };
        init();
    });

    var jc_plot_data = {{ plotsDict|safe }};
    app.controller('jobConsumptionPlotsController', function($scope) {
      $scope.taskinfo = {};
      $scope.taskinfo.jc_plots = {
        selection: {
          category: '',
          is_hidden: true,
          mode: ''
        },
        options: {
          category: []
        },
        plot_data: jc_plot_data,
        charts: {}
      };

      if (Object.keys($scope.taskinfo.jc_plots.plot_data).length > 1) {
        Object.keys($scope.taskinfo.jc_plots.plot_data[1].data.data).forEach((key) => {
          $scope.taskinfo.jc_plots.options.category.push(key);
        });
        $scope.taskinfo.jc_plots.options.category.sort();
        if ($scope.taskinfo.jc_plots.options.category.includes('run')) {
          $scope.taskinfo.jc_plots.selection.category = 'run';
        }
        else {
          $scope.taskinfo.jc_plots.selection.category = 'all';
        }
      }

      $scope.taskinfo.jc_plots.build = function () {
        $scope.taskinfo.jc_plots.plot_data.forEach((item) => {
          if (item.data.details.type === 'pie') {
            $scope.taskinfo.jc_plots.charts[item.name + "_chart"] = draw_donut(item.data.data[$scope.taskinfo.jc_plots.selection.category]['columns'], item.name + "_chart", item.data.details.title, {})
          }
          else if (item.data.details.type === 'stack_bar') {
            $scope.taskinfo.jc_plots.charts[item.name + "_chart"] = draw_stacked_bar_hist(item.data.data[$scope.taskinfo.jc_plots.selection.category], item.data.details, item.name + "_chart");
          }
        })
      };

      $scope.taskinfo.jc_plots.rebuild = function () {
        $scope.taskinfo.jc_plots.destroy();
        $scope.taskinfo.jc_plots.build();
      };

      $scope.taskinfo.jc_plots.destroy = function () {
        let plot_names = Object.keys($scope.taskinfo.jc_plots.charts);
        plot_names.forEach((item) => {
          if ($scope.taskinfo.jc_plots.charts[item]) {
            $scope.taskinfo.jc_plots.charts[item] = $scope.taskinfo.jc_plots.charts[item].destroy();
          }
        });
      };

      $scope.taskinfo.jc_plots.toggle = function () {
        if ($scope.taskinfo.jc_plots.options.category.length > 0) {
          ($scope.taskinfo.jc_plots.selection.is_hidden) ? $scope.taskinfo.jc_plots.selection.is_hidden = false : $scope.taskinfo.jc_plots.selection.is_hidden = true;
        }
      };

    })
    .directive('jcplotDirective', function ($timeout) {
        var template = '<div id="{$plot.name$}_chart"></div>';
        return {
            template: template,
            scope: {
                plot: '=',
                parent: '=',
            },
            link: function (scope, element, attrs) {
              $timeout(() => {
                element.ready(() => {
                  if (scope.plot.data.details.type === 'pie') {
                    scope.parent.taskinfo.jc_plots.charts[scope.plot.name + "_chart"] = draw_donut(scope.plot.data.data[scope.parent.taskinfo.jc_plots.selection.category]['columns'], scope.plot.name + "_chart", scope.plot.data.details.title, {})
                  }
                  else if (scope.plot.data.details.type === 'stack_bar') {
                    scope.parent.taskinfo.jc_plots.charts[scope.plot.name + "_chart"] = draw_stacked_bar_hist(scope.plot.data.data[scope.parent.taskinfo.jc_plots.selection.category], scope.plot.data.details, scope.plot.name + "_chart");
                  }
                });
              });
            }
        };
    });


    $(document).ready(function () {
        var dataset_list = {{ datasets|safe }};
        buildDatasetsTable(dataset_list);
        var url = window.location.href;
        if (url.indexOf("#plots") > -1) {
            togglePlots();
        }
    });

function togglePlots() {
  let scope = angular.element(document.getElementById('plots')).scope();
  scope.$apply(function(){
        scope.taskinfo.jc_plots.toggle();
  });
}


function killtasks(taskID, action) {
    var message = ''
    if (action == 0)
        message = 'Are you sure you want to FINISH this task?'
    else
        message = 'Are you sure you want to ABORT this task?'
    if (confirm(message)) {
        $.ajax({
            url: {% url 'killtasks' %},
            data: {'task': taskID, 'action': action},
            async: true
        })
        .done(function (response) {
            if (typeof response === 'string') {
                response = $.parseJSON(response);
            }
            alert(response.detail);
            location.reload();
        });
    } else {
        // Do nothing!
    }
}

function loadStatusLog(jeditaskid) {

    $('#div-statuslog').html("<img src='{% static "images/load.gif" %}'>  ");
    $.ajax({
        url: '{% url 'gettaskstatuslog' jeditaskid %}',
        data: '',
        async: true,
    }).done(function (response) {
        $('#div-statuslog').html(response);
    });

}

function buildDatasetsTable(data) {

  $('#datasetstable').dataTable({
    //"bRetrieve": true,
    "lengthMenu": [[10, 20, 50, 100, 200, -1], [10, 20, 50, 100, 200, "All"]],
    "paging": true,
    "scrollX": true,
    "aaSorting": [[0,'asc']],
    "columnDefs": [
        {"type": "num-html", "targets": [4,5,6,7] }
    ],
    "data": data,
    "aoColumns": [
        {
            "data": "datasetname",
            sDefaultContent: "---",
            "render": function(data, type, row, meta) {
                return '<a href = "{% url 'datasetInfo' %}?datasetid=' + row['datasetid'] + '">'+row['datasetname']+'</a>'
            }
        },
        {
            "data": "type",
            sDefaultContent: "-",
        },
        {
            "data": "streamname",
            sDefaultContent: "-",
        },
        {
            "data": "status",
            sDefaultContent: "-",
            className: 'state',
        },
        {
            "data": "nfiles",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                if (data > 0) {
                    return '<a href = "{% url 'fileList' %}?jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '">' + full['nfiles'] + '</a>'
                }
                else {
                    return data;
                }
            }
        },
        {
            "data": "nfilesfinished",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=finished&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] +  '"><snap class="finished">' + full['nfilesfinished'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
                }
        },
        {
            "data": "nfilesfailed",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=failed&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '"><snap class="failed">' + full['nfilesfailed'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
            }
        },
        {
            "data": "percentfinished",
            sDefaultContent: "-",
            className: 'num'
        },
        {
            "data": "type",
            sDefaultContent: "-",
            "render": function(data, type, row, meta) {
                var links = '<a href="https://rucio-ui.cern.ch/did?scope=' + row['scope'] + '&name=' + row['datasetname'] + '" target="_blank"><img src="/static/images/rucio-logo.png" width=14 height=14 border=0></a>';
                if (row['type'] == 'input') {
                     links += ', <a href = "{% url 'jobList' %}?datasetid=' + row['datasetid'] + '&jeditaskid=' + row['jeditaskid'] + '"> jobs </a>'
                }
                return links;
            }

        },

    ],
    "createdRow": function ( row, data, index ) {
        $('td', row).eq(3).addClass(data['status'] + '_fill');
    }
  })
}


</script>

{% endblock %}

{% block help %}
  <a name="help"></a>
  {% include "taskInfoHelp.html" %}
{% endblock %}
