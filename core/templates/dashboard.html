{% extends "_base_core.html" %}

{% block page_title %} {{ viewParams.MON_VO }} PanDA jobs{% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block subtitle %}PanDA {{view}} {{ requestParams.mode }} dashboard{{ viewParams.selection|safe }}
{% endblock %}
{% block body %}

{{ viewParams.header }}

{% if warning %}
<div class="callout alert large" data-closable>
  <h5>{{ warning }}</h5>
</div>
{% endif %}


{% if cloudview == 'region' %}
<div class="callout alert large" data-closable>
    <h5>Please participate in testing
        <a class="blacklink" href="{% url 'dashRegion' %}{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}"><b>a new nicer and faster dashboard page</b></a>,
        where a number of interactive filters are available and e.g. job counts for GU queues can be split by both job and resource types:
        <a class="blacklink" href="{% url 'dashRegion' %}{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}"><b>https://bigpanda.cern.ch/new/dash/{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}</b></a></h5>
  <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
  </button>
</div>
{% endif %}

{% if requestParams.sortby %} <p><b>Sorted by: {{ requestParams.sortby }} </b><p> {% endif %}

{% if viewParams.MON_VO != 'ATLAS' %}

<table width=800><tr><td>
This page summarizes recent job status for VOs, clouds and sites. Click on the numbers to see job listings.
Failure rates above {{ errthreshold }}% are shown in red.
Click the cloud name in the overall summary to go to the cloud's site summary.
Click the job counts to go to job listings.
Click on column titles to sort.
</td></tr></table>
<p>

<div class='section'>VO / Cloud / Site summary</div>
{% else %}


{% if noldtransjobs > 0 %}
<p>
<table>
<tr class='tablesection'>
<th> Jobs in transferring state more than {{ hoursSinceUpdate }} hours </th>
<th> Total </th>
{% for cloud in transclouds %}
<th> {{ cloud.name }} </th>
{% endfor %}
</tr>
<tr>
<td> By home cloud </td>
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&display_limit=100">{{ noldtransjobs }}</a> </td>
{% for cloud in transclouds %}
<td> {{ cloud.count }} </td>
{% endfor %}
</tr>
<tr>
<td> By assigned (multi-cloud production) cloud </td>
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&display_limit=100">{{ noldtransjobs }}</a> </td>
{% for cloud in transrclouds %}
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&cloud={{ cloud.name }}&display_limit=100">{{ cloud.count }}</a> </td>
{% endfor %}
</tr>
</table>
</p>
{% endif %}

{% endif %}


<table id="cloudsitesummary">

{% if viewParams.MON_VO != 'ATLAS' %}

<tr class='tablesection'><th colspan=20> VO summary </th></tr>
<tr class='tablesection'>
<th> <a href="{{nosorturl}}">VO</a> </th>
<th>  </th>
<th> nJobs </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>



{% for vo in vosummary %}
<tr height=10 colspan=12></tr>
<tr>
<th  bgcolor=whitesmoke> {{ vo.name }} </th>
<th bgcolor=whitesmoke> </th>
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'jobList' %}?vo={{ vo.name }}{{ estailtojobslinks }}&hours={{hours}}&jobtype={{ view }}&display_limit=100">{{ vo.count }}</a> </th>
{% for state in vo.statelist %}
<th {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'> <a href="{% url 'jobList' %}?vo={{ vo.name }}{{ estailtojobslinks }}&jobstatus={{ state.name }}&hours={{hours}}&jobtype={{ view }}&display_limit=100"> <span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}">{{ state.count }}</span></a> </th>
{% endfor %}
<th  bgcolor=whitesmoke align='right'>  {% if vo.pctfail > errthreshold %} <font color=red>{{ vo.pctfail  }}</font> {% else %} {{ vo.pctfail  }} {% endif %}  </th>
</tr>
{% endfor %}
<tr height=10 colspan=12></tr>

{% endif %}

{% if summary %}

<tr class='tablesection'><th colspan=20> Cloud / Site summary 
{% if view == 'analysis' %}
of analysis jobs
{% elif view == 'production' %}
of production jobs
{% else %}
of all jobs
{% endif %}
{% if view != 'analysis' %}
{% if cloudview == 'region' %}
- Region view         For a description of region view
{% else %}
- Cloud view         For a description of cloud view
{% endif %}
{% else %}
        For a description
{% endif %}
<a href="#doc"><span class="helpdark">see below</a>
</th></tr>

<tr class='tablesection'>
<th> <a href="{{nosorturl}}">Cloud</a> </th>
<th> Status</th>
<th> nJobs </th>
{% if cloudview == 'region' %}
<th> nPilots (Sum(nojobabs)) </th>
{% endif %}
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>

{% for cloud in summary %}
<tr height=10 colspan=12></tr>
<tr>
<th  bgcolor=whitesmoke> {% if cloud.name != 'All' %}{% if cloud.name != '' %}<a href="#cloud_{{ cloud.name }}"><span class="{{cloud.status}}">{{ cloud.name }}</span></a> {% else %} Failed before site assigned {% endif %} {% else %} All clouds {% endif %}</th>
<th  bgcolor=whitesmoke> <span class="{{cloud.status}}">{{ cloud.status }}</span> </th>
<th  bgcolor=whitesmoke align='right'>{{ cloud.count }}</th>
{% if cloudview == 'region' %}
<th  bgcolor=whitesmoke align='right'> {{ cloud.pilots }} ({{ cloud.nojobabs }}) </th>
{% endif %}
{% for state in cloud.statelist %}
<th  {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'><span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}"> {{ state.count }}</span></td>
{% endfor %}
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'errorSummary' %}?jobtype={{view}}{{ estailtojobslinks }}{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&jobtype={{view}}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&sortby=count&cloud={{cloud.name}}&hours={{hours}}"> {% if cloud.pctfail > errthreshold %} <font color=red>{{ cloud.pctfail  }}</font> {% else %} {{ cloud.pctfail  }} {% endif %} </a></th>
</tr>
{% endfor %}


{% for cloud in summary %}

{% if cloud.name != 'All' %}

<tr height=10 colspan=12></tr>
<tr>
<th class="tablesection"> <a name="cloud_{{ cloud.name }}"><span class="{{cloud.status}}">{{ cloud.name }} Cloud</span></a>, Sites </th>
<th class="tablesection"> Status</th>
<th class="tablesection"> nJobs </th>
{% if cloudview == 'region' %}
<th class="tablesection"> nPilots (sum(nojobabs)) </th>
{% endif %}
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>


<tr height=10 colspan=12></tr>
<tr>
<th bgcolor=whitesmoke> {{ cloud.name }} all sites {% if cloudview != 'region' and view != 'analysis' %} including MCP {% endif %}</th>
<th bgcolor=whitesmoke> </th>
<th bgcolor=whitesmoke align='right'>{{ cloud.count }}</th>
{% if cloudview == 'region' %}
<th> {{ cloud.pilots }} ({{ cloud.nojobabs }}) </th>
{% endif %}
{% for state in cloud.statelist %}
<th {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'><span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}">{{ state.count }}</span></th>
{% endfor %}
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'errorSummary' %}?jobtype={{view}}{{ estailtojobslinks }}&sortby=count{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&jobtype={{view}}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&cloud={{cloud.name}}&hours={{hours}}"> {% if cloud.pctfail > errthreshold %} <font color=red>{{ cloud.pctfail  }}</font> {% else %} {{ cloud.pctfail  }} {% endif %} </a> </th>
</tr>
{% for site in cloud.summary %}
    {% if site.parent %}
    <tr class="parent">

    {% else %}
    <tr  {% if site.status == 'offline' or site.status == 'brokeroff'%} class="hideofflinerow" {% endif %}>
    {% endif %}
    <td>
        {% if site.name %}
            {% if site.parent %}
                {{ site.parent }} [{{ site.resource }}]
            {% else %}
              <a href="{% url 'siteInfo' site.name %}"><span class="{{ site.status }}">{{ site.name }}</span></a>
            {% endif %}
        {% else %}
            Failed before site assignment
        {% endif %}
    {% if site.sumres and 1 == 0 %}
        <br/><hr style="height:1px; background-color: #0a0a0a; margin: auto" size=1>
    {% for res in site.sumres %}
        {{ res }} <br/>
    {% endfor %}
    {% endif %}

    </td>

    {% get_renderedrow type="region_sitesummary" errorSummary='/errors/' errthreshold=errthreshold cloudname=cloud.name requestParams=requestParams site=site joblisturl='/jobs/' view=view cloudview=cloudview estailtojobslinks=estailtojobslinks hours=hours %}
{% endfor %}

{% endif %}

{% endfor %}
</table>

{% endif %}

{% endblock %}

{% block helptext %}
<tr class="docsection"><th><a name="dashboardHelp"></a> Dashboard help </th></tr>
<tr><td class="doctextlight">

{% if viewParams.MON_VO != 'ATLAS' %}

<p>
This page summarizes recent job status for VOs, clouds and sites. Click on the numbers to see job listings.
Note that only sites that have jobs in the system within the sampled period are shown. It is not a static list of available sites that is shown.
</p>

<p>
Click the cloud name in the overall summary to go to the cloud's site summary.
</p>

{% endif %}

{% if viewParams.MON_VO == 'ATLAS' %}

{% if mode == 'site' or show == 'all' %}

    {% if view != 'analysis' or show == 'all' %}

        {% if cloudview == 'region' or show == 'all' %}

<p>
        <b>Region view</b><br>
        This view associates jobs with clouds on the basis of the region in which the processing site is located.
        The alternative <a href="{% url 'dashProduction' %}">'cloud' view</a> associates jobs with clouds on the basis of which Tier 1 the job is assigned to (which can be different for a site participating in multi-cloud production).
        Click the cloud name in the overall summary to go to the cloud's site summary.
        Click the job counts to go to job listings.
</p>

        {% endif %}
        {% if cloudview == 'cloud' or show == 'all' %}

<p>
        <b>Cloud view</b><br>
        This view associates jobs with clouds on the basis of which Tier 1 the job is assigned to, which can be different from the 'home cloud' of the processing site for a site participating in multi-cloud production (MCP). Thus in this view you may see sites listed in the CA cloud which are not located in CA.
        The alternative <a href="{% url 'dashProduction' %}?cloudview=region">'region' view</a> associates production jobs with clouds on the basis of the region in which the processing site is located.
        Click the cloud name in the overall summary to go to the cloud's site summary.
</p>

        {% endif %}

    {% elif view == 'analysis' %}

<p>
    Click the cloud name in the overall summary to go to the cloud's site summary.
</p>

    {% endif %}

<p>
Pilot counts (nPilots) are for the last 3 hours. They are only shown in region view (they only make sense in that view, they are regional by nature).
</p>

{% endif %}

{% endif %}

<p>
Click on column titles to sort.
Click the job counts to go to job listings.
Failure rates above {{ errthreshold }}% are shown in red.
Click on the failure percentage to go to an error summary.
</p>

</td>
{% endblock %}

{% block help %}
{% include "jobInfoHelp.html" with show="all" %}
{% endblock %}